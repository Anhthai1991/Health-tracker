<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Health Ultimate</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3c72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        .main-content { flex: 1; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .header-gradient { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 40px 0 30px; border-radius: 0 0 30px 30px; margin-bottom: 30px; }
        .tool-btn { border-radius: 12px; padding: 15px; font-weight: 600; border: none; width: 100%; margin-bottom: 10px; text-align: left; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-loading { display: none; }
        .ai-badge { background: linear-gradient(45deg, #8e44ad, #3498db); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; margin-left: 5px; }
        .water-section { background: white; border-radius: 16px; padding: 20px; text-align: center; }
        
        /* In ·∫•n (Doctor View) */
        @media print {
            .no-print, .header-gradient, footer, .tool-btn, .search-section, .water-section { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; }
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
            body { background: white; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>

    <div class="header-gradient text-center no-print">
        <div class="container">
            <h1 class="fw-bold">Nguy·ªÖn Anh Th√°i <span class="ai-badge">Ultimate</span></h1>
            <p class="opacity-75">Gout ‚Ä¢ Men Gan ‚Ä¢ Th·∫≠n (eGFR) ‚Ä¢ Tr√†o ng∆∞·ª£c</p>
            <button class="btn btn-sm btn-outline-light mt-2 rounded-pill" data-bs-toggle="modal" data-bs-target="#keyModal">
                <i class="bi bi-key-fill"></i> C√†i ƒë·∫∑t Gemini API
            </button>
            <div id="modelStatus" class="small mt-2 text-warning" style="font-size: 0.8em;"></div>
        </div>
    </div>

    <div class="print-header">
        <h2>B√ÅO C√ÅO S·ª®C KH·ªéE: NGUY·ªÑN ANH TH√ÅI</h2>
        <p>Ng√†y xu·∫•t b√°o c√°o: <script>document.write(new Date().toLocaleDateString('vi-VN'))</script></p>
        <hr>
    </div>

    <div class="container main-content">
        
        <div class="row mb-4 no-print">
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-primary" onclick="window.print()">
                    <span><i class="bi bi-printer-fill"></i> Doctor View</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-success" data-bs-toggle="modal" data-bs-target="#adminModal">
                    <span><i class="bi bi-code-slash"></i> Admin Tool</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-danger" onclick="generateAIMenu()">
                    <span><i class="bi bi-stars"></i> AI G·ª£i √Ω m√≥n</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-warning" onclick="checkHealthAI()">
                    <span><i class="bi bi-activity"></i> AI Ph√¢n t√≠ch</span>
                </button>
            </div>
        </div>

        <div class="row mb-4 search-section">
            <div class="col-md-12">
                <div class="card p-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="foodSearch" class="form-control border-0" placeholder="H·ªèi AI v·ªÅ th·ª±c ph·∫©m (VD: B√∫n ri√™u, Tr√† s·ªØa...)" onkeypress="handleEnter(event)">
                        <button class="btn btn-primary rounded-pill px-4" onclick="searchWithAI()">H·ªèi Gemini</button>
                    </div>
                    <div id="aiLoading" class="text-center mt-3 ai-loading">
                        <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                        <small class="text-muted ms-2">Gemini ƒëang suy nghƒ©...</small>
                    </div>
                    <div id="searchResult" class="mt-3 px-2"></div>
                </div>
            </div>
        </div>

        <div id="menuResult" class="card p-3 mb-4 bg-white border-primary" style="display:none; border-left: 5px solid #0d6efd;">
            <h5 class="text-primary"><i class="bi bi-robot"></i> Gemini t∆∞ v·∫•n:</h5>
            <div id="menuContent" class="small"></div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card p-3">
                    <h5 class="card-title text-primary"><i class="bi bi-table"></i> B·∫£ng Theo D√µi Ch·ªâ S·ªë Chi Ti·∫øt</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover text-center small" id="compareTable">
                            <thead class="table-light"></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-7">
                <div class="card p-3 h-100">
                    <h5 class="card-title">üìä Di·ªÖn bi·∫øn Gout & Gan</h5>
                    <canvas id="labChart"></canvas>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-3 h-100">
                    <h5 class="card-title">‚öñÔ∏è C√¢n n·∫∑ng & M·ª•c ti√™u</h5>
                    <canvas id="weightChart"></canvas>
                    <div class="text-center mt-2 no-print">
                        <small class="text-muted">M·ª•c ti√™u: <span id="targetWeightDisplay">--</span> kg</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4 water-section h-100">
                <h5 class="text-info"><i class="bi bi-droplet-fill"></i> N∆∞·ªõc u·ªëng h√¥m nay</h5>
                <h1 class="display-2 fw-bold text-primary" id="waterCount">0</h1>
                <p class="text-muted">ly (250ml) / M·ª•c ti√™u: <span id="waterTargetDisplay">--</span> L</p>
                <div class="progress mb-3" style="height: 10px;">
                    <div id="waterProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary rounded-pill" onclick="addWater()">+ U·ªëng 1 Ly</button>
                    <button class="btn btn-sm btn-link text-muted" onclick="resetWater()">Reset</button>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card p-3 h-100">
                    <h5>üìí Nh·∫≠t k√Ω & ƒê√°nh gi√°</h5>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead><tr><th>Ng√†y</th><th>N·ªôi dung</th><th>AI ƒê√°nh gi√°</th></tr></thead>
                            <tbody id="mealTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4 no-print">
            <div class="col-12">
                <div class="card p-3">
                    <h5>‚è∞ L·ªãch tr√¨nh sinh ho·∫°t khuy·∫øn ngh·ªã</h5>
                    <div class="row small text-muted" id="lifestyleTips"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="no-print bg-white py-3 text-center mt-auto border-top">
        <div class="container">
            <small class="text-muted">¬© 2025 Thai Health Tracker | Powered by Gemini AI</small>
        </div>
    </footer>

    <div class="modal fade" id="keyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">C√†i ƒë·∫∑t Gemini API</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Nh·∫≠p API Key. H·ªá th·ªëng s·∫Ω T·ª∞ ƒê·ªòNG CH·ªåN model mi·ªÖn ph√≠ t·ªët nh·∫•t (gemini-1.5-flash).</p>
                    <input type="password" id="apiKeyInput" class="form-control mb-2" placeholder="Paste API Key v√†o ƒë√¢y...">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showKey">
                        <label class="form-check-label small" for="showKey">Hi·ªán Key</label>
                    </div>
                    <button class="btn btn-primary w-100" onclick="saveKeyAndDetect()">L∆∞u & Fix L·ªói Model</button>
                    <hr>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="small">üëâ L·∫•y API Key mi·ªÖn ph√≠</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Tool: T·∫°o JSON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-target="#tabCheckup" data-bs-toggle="tab">Kh√°m b·ªánh</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#tabWeight" data-bs-toggle="tab">C√¢n n·∫∑ng</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#tabMeal" data-bs-toggle="tab">Nh·∫≠t k√Ω ƒÉn</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tabCheckup">
                            <div class="mb-2"><label>Ng√†y:</label><input type="date" id="inpDate" class="form-control"></div>
                            <div class="row">
                                <div class="col-6 mb-2"><label>Acid Uric:</label><input type="number" id="inpUric" class="form-control" placeholder="¬µmol/L"></div>
                                <div class="col-6 mb-2"><label>Men gan (ALT):</label><input type="number" id="inpAlt" class="form-control" placeholder="U/L"></div>
                                <div class="col-6 mb-2"><label>Creatinine:</label><input type="number" id="inpCre" class="form-control" placeholder="¬µmol/L"></div>
                                <div class="col-6 mb-2"><label>eGFR:</label><input type="number" id="inpEgfr" class="form-control" placeholder="ml/min"></div>
                                <div class="col-6 mb-2"><label>Cholesterol:</label><input type="number" id="inpChol" class="form-control" placeholder="mmol/L"></div>
                                <div class="col-6 mb-2"><label>Triglyceride:</label><input type="number" id="inpTri" class="form-control" placeholder="mmol/L"></div>
                            </div>
                            <div class="mb-2"><label>Ghi ch√∫:</label><input type="text" id="inpNote" class="form-control" placeholder="VD: Gout c·∫•p t√≠nh, H·ªìi ph·ª•c t·ªët..."></div>
                            <button class="btn btn-primary w-100 mt-2" onclick="genCheckupJSON()">T·∫°o Code JSON</button>
                        </div>
                        <div class="tab-pane fade" id="tabWeight">
                            <div class="mb-2"><label>Ng√†y:</label><input type="date" id="inpWDate" class="form-control"></div>
                            <div class="mb-2"><label>C√¢n n·∫∑ng (kg):</label><input type="number" id="inpWeight" class="form-control"></div>
                            <button class="btn btn-success w-100 mt-2" onclick="genWeightJSON()">T·∫°o Code JSON</button>
                        </div>
                        <div class="tab-pane fade" id="tabMeal">
                             <div class="mb-2"><label>Ng√†y:</label><input type="date" id="inpMDate" class="form-control"></div>
                             <div class="mb-2"><label>N·ªôi dung:</label><textarea id="inpMContent" class="form-control" rows="2"></textarea></div>
                             <div class="mb-2"><label>AI ƒê√°nh gi√°:</label><textarea id="inpMEval" class="form-control" rows="2"></textarea></div>
                             <button class="btn btn-warning w-100 mt-2" onclick="genMealJSON()">T·∫°o Code JSON</button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label>K·∫øt qu·∫£ (Copy v√†o data.json):</label>
                        <textarea id="jsonOutput" class="form-control bg-light text-monospace" rows="4" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let foodDB = [];
        let healthProfile = {};
        const CUP_SIZE = 0.25; 
        let dailyTarget = 2.5; 

        // KH·ªûI T·∫†O
        fetch('data.json').then(r => r.json()).then(data => {
            foodDB = data.food_database;
            healthProfile = {
                conditions: data.profile.conditions.join(", "),
                lastCheckup: data.medical_checkups[data.medical_checkups.length - 1]
            };
            
            renderLabChart(data.medical_checkups);
            renderWeightChart(data.weight_log, data.profile.target_weight);
            renderCompareTable(data.medical_checkups);
            renderMeals(data.meal_logs);
            renderLifestyle(data.lifestyle_tips);
            
            document.getElementById('targetWeightDisplay').innerText = data.profile.target_weight;
            calculateTarget(data.medical_checkups[data.medical_checkups.length - 1]);
            loadWater();

            // Check Key & Model
            const key = localStorage.getItem('geminiKey');
            let savedModel = localStorage.getItem('geminiModel');
            
            // FIX L·ªñI MODEL: N·∫øu model ƒëang l∆∞u l√† b·∫£n preview/exp, x√≥a ngay l·∫≠p t·ª©c
            if (savedModel && (savedModel.includes('preview') || savedModel.includes('exp') || savedModel.includes('2.5'))) {
                console.log("Ph√°t hi·ªán model l·ªói quota, ƒëang reset...");
                localStorage.removeItem('geminiModel');
                savedModel = null;
            }

            if(key) {
                document.getElementById('apiKeyInput').value = key;
                if(savedModel) document.getElementById('modelStatus').innerText = `‚úÖ Connected: ${savedModel}`;
                else detectModel(key);
            } else {
                 const modal = new bootstrap.Modal(document.getElementById('keyModal'));
                 modal.show();
            }
        });

        // --- AI LOGIC (FIXED: ∆ØU TI√äN FLASH 1.5) ---
        async function detectModel(key) {
            const statusDiv = document.getElementById('modelStatus');
            statusDiv.innerText = "‚è≥ ƒêang t√¨m model mi·ªÖn ph√≠...";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await response.json();
                if(data.error) { alert('Key l·ªói: ' + data.error.message); return; }

                // DANH S√ÅCH ∆ØU TI√äN TUY·ªÜT ƒê·ªêI
                const priority = [
                    "gemini-1.5-flash",          // Ngon nh·∫•t, free nhi·ªÅu nh·∫•t
                    "gemini-1.5-flash-latest", 
                    "gemini-1.5-pro", 
                    "gemini-pro"
                ];
                
                let selected = null;
                for (let p of priority) {
                    // T√¨m ch√≠nh x√°c ƒëu√¥i model
                    const f = data.models.find(m => m.name.endsWith(p));
                    if (f) { 
                        selected = f.name.replace("models/", ""); 
                        break; 
                    }
                }

                // N·∫øu kh√¥ng th·∫•y trong list ∆∞u ti√™n, t√¨m fallback nh∆∞ng TR√ÅNH XA b·∫£n exp/preview
                if (!selected) { 
                    const fb = data.models.find(m => 
                        m.supportedGenerationMethods.includes("generateContent") && 
                        !m.name.includes("exp") && 
                        !m.name.includes("preview")
                    );
                    if(fb) selected = fb.name.replace("models/", "");
                }

                if (selected) {
                    localStorage.setItem('geminiModel', selected);
                    statusDiv.innerText = `‚úÖ ƒê√£ ch·ªçn: ${selected}`;
                    alert(`ƒê√£ fix l·ªói Quota! ƒêang d√πng model: ${selected}`);
                } else {
                    // B∆∞·ªõc ƒë∆∞·ªùng c√πng: Hardcode lu√¥n
                    localStorage.setItem('geminiModel', 'gemini-1.5-flash');
                    statusDiv.innerText = "‚ö†Ô∏è Force: gemini-1.5-flash";
                }
            } catch (e) { console.error(e); statusDiv.innerText = "‚ùå L·ªói m·∫°ng"; }
        }

        async function callGemini(prompt) {
            const key = localStorage.getItem('geminiKey');
            let modelName = localStorage.getItem('geminiModel') || 'gemini-1.5-flash';
            
            // Ch·∫∑n ngay n·∫øu model l√† b·∫£n preview (tr√°nh l·ªói 429)
            if (modelName.includes('preview') || modelName.includes('2.5')) {
                modelName = 'gemini-1.5-flash';
                localStorage.setItem('geminiModel', modelName);
            }

            if(!key) { alert('Ch∆∞a c√≥ Key!'); return null; }

            document.getElementById('aiLoading').style.display = 'block';
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
                const res = await fetch(url, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                document.getElementById('aiLoading').style.display = 'none';

                if (data.error) {
                    // N·∫øu l·ªói Quota ho·∫∑c Not Found -> Reset ngay l·∫≠p t·ª©c
                    if(data.error.message.includes('quota') || data.error.message.includes('not found')) {
                        alert('Model hi·ªán t·∫°i b·ªã l·ªói Quota. ƒêang t·ª± ƒë·ªông chuy·ªÉn v·ªÅ b·∫£n Flash mi·ªÖn ph√≠...');
                        localStorage.setItem('geminiModel', 'gemini-1.5-flash'); // Force reset
                        return await callGemini(prompt); // Th·ª≠ l·∫°i ngay
                    }
                    alert('L·ªói Google: ' + data.error.message); return null;
                }
                if (!data.candidates || !data.candidates.length) return "AI kh√¥ng ph·∫£n h·ªìi.";
                return data.candidates[0].content.parts[0].text;
            } catch (e) { document.getElementById('aiLoading').style.display = 'none'; alert('L·ªói m·∫°ng: ' + e.message); return null; }
        }

        function saveKeyAndDetect() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) {
                localStorage.setItem('geminiKey', key);
                localStorage.removeItem('geminiModel'); // Reset model c≈©
                bootstrap.Modal.getInstance(document.getElementById('keyModal')).hide();
                detectModel(key);
            }
        }

        // --- AI FEATURES ---
        async function searchWithAI() {
            const query = document.getElementById('foodSearch').value;
            if(!query) return;
            const local = foodDB.find(f => f.name.toLowerCase().includes(query.toLowerCase()));
            const resDiv = document.getElementById('searchResult');
            
            if(local) {
                let color = local.status === 'green' ? 'success' : (local.status === 'yellow' ? 'warning' : 'danger');
                resDiv.innerHTML = `<div class="alert alert-${color}"><strong>(Database) ${local.name}</strong>: ${local.reason}</div>`;
                return;
            }
            const prompt = `B·ªánh nh√¢n: ${healthProfile.conditions}. Acid Uric ${healthProfile.lastCheckup.uric_acid}, Men gan ${healthProfile.lastCheckup.alt_liver}. ƒê√°nh gi√° m√≥n "${query}". Tr·∫£ v·ªÅ JSON: {"status": "green/yellow/red", "reason": "ng·∫Øn g·ªçn", "name": "${query}"}`;
            const aiRes = await callGemini(prompt);
            if(aiRes) {
                try {
                    const clean = aiRes.replace(/```json|```/g, '').trim();
                    const d = JSON.parse(clean);
                    let c = d.status === 'green' ? 'success' : (d.status === 'yellow' ? 'warning' : 'danger');
                    resDiv.innerHTML = `<div class="alert alert-${c}"><strong>ü§ñ AI: ${d.name}</strong><br>${d.reason}</div>`;
                } catch (e) { resDiv.innerHTML = `<div class="alert alert-secondary">${aiRes}</div>`; }
            }
        }
        function handleEnter(e) { if(e.key === 'Enter') searchWithAI(); }

        async function generateAIMenu() {
            const prompt = `G·ª£i √Ω th·ª±c ƒë∆°n 1 ng√†y (S√°ng, Tr∆∞a, T·ªëi) cho ng∆∞·ªùi b·ªã: ${healthProfile.conditions}. Ch·ªâ s·ªë: Acid Uric ${healthProfile.lastCheckup.uric_acid}, Men gan ${healthProfile.lastCheckup.alt_liver}. M√≥n Vi·ªát Nam d·ªÖ n·∫•u. ƒê·ªãnh d·∫°ng Markdown.`;
            const res = await callGemini(prompt);
            if(res) { document.getElementById('menuResult').style.display='block'; document.getElementById('menuContent').innerHTML = marked.parse(res); }
        }
        async function checkHealthAI() {
            const prompt = `D·ª±a tr√™n l·ªãch s·ª≠: ${JSON.stringify(healthProfile.lastCheckup)}. Cho 3 l·ªùi khuy√™n ng·∫Øn g·ªçn c·∫£i thi·ªán s·ª©c kh·ªèe.`;
            const res = await callGemini(prompt);
            if(res) { document.getElementById('menuResult').style.display='block'; document.getElementById('menuContent').innerHTML = marked.parse(res); }
        }

        // --- RENDER B·∫¢NG SO S√ÅNH (PIVOT TABLE) ---
        function renderCompareTable(logs) {
            const table = document.getElementById('compareTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            let headerHTML = `<tr><th class="text-start" style="min-width: 150px;">Ch·ªâ s·ªë</th><th style="width: 100px;">Ng∆∞·ª°ng</th>`;
            logs.forEach(log => { headerHTML += `<th>${log.date}</th>`; });
            headerHTML += `</tr>`;
            thead.innerHTML = headerHTML;

            const metrics = [
                { group: true, name: 'GOUT & TH·∫¨N' },
                { name: 'Acid Uric', key: 'uric_acid', unit: '¬µmol/L', range: '180-420' },
                { name: 'Creatinine', key: 'creatinine', unit: '¬µmol/L', range: '62-120' },
                { name: 'eGFR (Th·∫≠n)', key: 'egfr', unit: 'mL/min', range: '> 90' },
                { group: true, name: 'GAN (Men gan)' },
                { name: 'ALT (GPT)', key: 'alt_liver', unit: 'U/L', range: '< 40' },
                { name: 'AST (GOT)', key: 'ast_liver', unit: 'U/L', range: '< 37' },
                { name: 'GGT', key: 'ggt_liver', unit: 'U/L', range: '11-50' },
                { group: true, name: 'M·ª† M√ÅU & ƒê∆Ø·ªúNG' },
                { name: 'Cholesterol', key: 'cholesterol', unit: 'mmol/L', range: '3.9-5.2' },
                { name: 'Triglyceride', key: 'triglyceride', unit: 'mmol/L', range: '0.46-1.88' },
                { name: 'Glucose', key: 'glucose', unit: 'mmol/L', range: '3.9-6.4' },
                { group: true, name: 'C√îNG TH·ª®C M√ÅU' },
                { name: 'H·ªìng c·∫ßu (RBC)', key: 'rbc', unit: 'M/¬µL', range: '3.7-5.2' },
                { name: 'Huy·∫øt s·∫Øc t·ªë', key: 'hgb', unit: 'g/dL', range: '9-16.5' }
            ];

            tbody.innerHTML = '';
            metrics.forEach(m => {
                if (m.group) {
                    tbody.innerHTML += `<tr class="table-secondary"><td colspan="${logs.length + 2}" class="fw-bold text-start">${m.name}</td></tr>`;
                } else {
                    let rowHTML = `<tr><td class="text-start fw-bold">${m.name} <span class="text-muted small">(${m.unit})</span></td><td class="text-muted small"><em>${m.range}</em></td>`;
                    logs.forEach(log => {
                        let val = log[m.key];
                        let displayVal = (val !== undefined && val !== null) ? val : '-';
                        let colorClass = '';
                        // T√¥ m√†u c·∫£nh b√°o ƒë∆°n gi·∫£n
                        if (m.key === 'uric_acid' && val > 420) colorClass = 'text-danger fw-bold';
                        else if ((m.key === 'alt_liver' || m.key === 'ast_liver') && val > 40) colorClass = 'text-danger fw-bold';
                        else if (m.key === 'uric_acid' && val <= 420 && val > 0) colorClass = 'text-success fw-bold';
                        rowHTML += `<td class="${colorClass}">${displayVal}</td>`;
                    });
                    rowHTML += `</tr>`;
                    tbody.innerHTML += rowHTML;
                }
            });
        }

        // --- CHART ---
        function renderLabChart(logs) {
            const ctx = document.getElementById('labChart').getContext('2d');
            const pColors = logs.map(l => (l.note||'').includes('c·∫•p') ? '#e74c3c' : ((l.note||'').includes('t·ªët')||(l.note||'').includes('h·ªìi ph·ª•c') ? '#27ae60' : '#f1c40f'));
            const pStyles = logs.map(l => (l.note||'').includes('t·ªët')||(l.note||'').includes('h·ªìi ph·ª•c') ? 'star' : ((l.note||'').includes('c·∫•p') ? 'rectRot' : 'circle'));
            const pSizes = logs.map(l => (l.note && l.note.length > 5) ? 8 : 4);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [
                        { label: 'Gout', data: logs.map(l => l.uric_acid), borderColor: '#e74c3c', pointBackgroundColor: pColors, pointStyle: pStyles, pointRadius: pSizes, yAxisID: 'y' },
                        { label: 'Men gan', data: logs.map(l => l.alt_liver), borderColor: '#f1c40f', pointRadius: 0, yAxisID: 'y1' },
                        { label: 'Ng∆∞·ª°ng Gout', data: Array(logs.length).fill(420), borderColor: 'rgba(231,76,60,0.2)', borderDash:[5,5], pointRadius:0, yAxisID:'y' }
                    ]
                },
                options: { 
                    responsive: true, 
                    plugins: { tooltip: { callbacks: { footer: (items) => { const n = logs[items[0].dataIndex].note; return n ? 'üìå ' + n : ''; } } } },
                    scales: { y: {position:'left', title:{display:true,text:'Uric'}}, y1: {position:'right', grid:{drawOnChartArea:false}} } 
                }
            });
        }
        function renderWeightChart(logs, target) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [
                        { label: 'Kg', data: logs.map(l => l.value), borderColor: '#3498db', tension: 0.3, fill:true, backgroundColor: 'rgba(52,152,219,0.1)' },
                        { label: 'M·ª•c ti√™u', data: Array(logs.length).fill(target), borderColor: '#27ae60', borderDash:[5,5], pointRadius:0 }
                    ]
                }
            });
        }

        // --- ADMIN TOOL HELPERS ---
        function genCheckupJSON() {
            const obj = {
                date: document.getElementById('inpDate').value,
                uric_acid: parseFloat(document.getElementById('inpUric').value),
                alt_liver: parseFloat(document.getElementById('inpAlt').value),
                creatinine: parseFloat(document.getElementById('inpCre').value)||null,
                egfr: parseFloat(document.getElementById('inpEgfr').value)||null,
                cholesterol: parseFloat(document.getElementById('inpChol').value)||null,
                triglyceride: parseFloat(document.getElementById('inpTri').value)||null,
                note: document.getElementById('inpNote').value
            };
            showJSON(obj);
        }
        function genWeightJSON() { showJSON({ date: document.getElementById('inpWDate').value, value: parseFloat(document.getElementById('inpWeight').value) }); }
        function genMealJSON() { showJSON({ date: document.getElementById('inpMDate').value, content: document.getElementById('inpMContent').value, evaluation: document.getElementById('inpMEval').value }); }
        function showJSON(obj) {
            const out = document.getElementById('jsonOutput');
            out.value = JSON.stringify(obj, null, 2) + ",";
            out.select(); document.execCommand('copy'); alert('ƒê√£ Copy!');
        }

        // --- UI HELPERS ---
        function renderLifestyle(tips) {
            document.getElementById('lifestyleTips').innerHTML = `
                <div class="col-6 col-md-3 mb-2">üåÖ <b>S√°ng:</b><br>${tips.morning}</div>
                <div class="col-6 col-md-3 mb-2">üç± <b>ƒÇn:</b><br>${tips.eating}</div>
                <div class="col-6 col-md-3 mb-2">üåô <b>T·ªëi:</b><br>${tips.evening}</div>
                <div class="col-6 col-md-3 mb-2">üèÉ <b>T·∫≠p:</b><br>${tips.exercise}</div>`;
        }
        function renderMeals(logs) {
             const tbody = document.getElementById('mealTable'); tbody.innerHTML = '';
             logs.slice().reverse().slice(0,10).forEach(log => {
                tbody.innerHTML += `<tr><td>${log.date}</td><td>${log.content}</td><td><em class="text-success small">${log.evaluation}</em></td></tr>`;
            });
        }
        function calculateTarget(latest) { if(latest.uric_acid > 400 || latest.alt_liver > 40) dailyTarget = 3.0; else dailyTarget = 2.5; document.getElementById('waterTargetDisplay').innerText = dailyTarget; }
        
        // Water Logic
        function loadWater() {
            const t = new Date().toLocaleDateString('vi-VN');
            const s = localStorage.getItem('waterDate');
            let c = (s === t) ? parseInt(localStorage.getItem('waterCount'))||0 : 0;
            if(s !== t) { localStorage.setItem('waterDate', t); localStorage.setItem('waterCount', 0); }
            updateWaterUI(c);
        }
        function addWater() {
            let c = (parseInt(localStorage.getItem('waterCount'))||0) + 1;
            localStorage.setItem('waterCount', c); localStorage.setItem('waterDate', new Date().toLocaleDateString('vi-VN'));
            updateWaterUI(c);
        }
        function resetWater() { if(confirm('Reset?')) { localStorage.setItem('waterCount', 0); updateWaterUI(0); } }
        function updateWaterUI(c) {
            document.getElementById('waterCount').innerText = c;
            const p = Math.min((c * CUP_SIZE / dailyTarget) * 100, 100);
            const b = document.getElementById('waterProgress');
            b.style.width = p + '%';
            if(p>=100) { b.classList.remove('bg-info'); b.classList.add('bg-success'); }
        }

        document.getElementById('showKey').addEventListener('change', function() { document.getElementById('apiKeyInput').type = this.checked ? 'text' : 'password'; });
    </script>
</body>
</html>