<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Health Ultimate</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3c72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: rgba(0,0,0,0.05);
            --input-bg: #ffffff;
            --input-border: #dee2e6;
            --table-th-bg: #f8f9fa;
            --modal-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: rgba(255,255,255,0.1);
            --input-bg: #2c2c2c;
            --input-border: #444;
            --table-th-bg: #2c2c2c;
            --modal-bg: #1e1e1e;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; min-height: 100vh; display: flex; flex-direction: column; transition: background-color 0.3s, color 0.3s; }
        .main-content { flex: 1; }
        
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; background: var(--bg-card); color: var(--text-main); transition: background-color 0.3s; }
        [data-theme="dark"] .card { box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid #333; }
        
        .header-gradient { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 40px 0 30px; border-radius: 0 0 30px 30px; margin-bottom: 30px; }
        
        .tool-btn { border-radius: 12px; padding: 12px; font-weight: 600; border: none; width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 0.9rem; background: var(--bg-card) !important; transition: 0.3s; }
        [data-theme="dark"] .tool-btn { background: #2c2c2c !important; color: #e0e0e0 !important; box-shadow: none; border: 1px solid #444; }
        
        .form-control, .form-select { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text-main); }
        .form-control:focus { background-color: var(--input-bg); color: var(--text-main); }
        [data-theme="dark"] .form-control::placeholder { color: #6c757d; }
        
        .table { color: var(--text-main); }
        .table thead th { background-color: var(--table-th-bg) !important; color: var(--text-main); border-color: var(--border-color); }
        .table td { border-color: var(--border-color); }
        
        .modal-content { background-color: var(--modal-bg); color: var(--text-main); }
        .btn-close { filter: var(--btn-close-filter); }
        [data-theme="dark"] .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

        .chart-legend { display: flex; justify-content: center; gap: 15px; margin-top: 10px; font-size: 0.8rem; color: var(--text-muted); }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        @media print {
            .no-print, .header-gradient, footer, .tool-btn, .search-section { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; background: white !important; color: black !important; }
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
            body { background: white !important; color: black !important; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>

    <div class="header-gradient text-center no-print">
        <div class="container position-relative">
            <button class="btn btn-sm btn-outline-light rounded-circle position-absolute top-0 end-0 mt-0" onclick="toggleTheme()" id="themeBtn">
                <i class="bi bi-moon-fill"></i>
            </button>

            <h2 class="fw-bold" id="headerName">Nguy·ªÖn Anh Th√°i</h2>
            <p class="opacity-75 small">Dashboard Theo D√µi S·ª©c Kh·ªèe</p>
            <button class="btn btn-sm btn-outline-light rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#keyModal">
                <i class="bi bi-key-fill"></i> C√†i ƒë·∫∑t AI
            </button>
            <div id="modelStatus" class="small mt-2 text-warning" style="font-size: 0.75em;"></div>
        </div>
    </div>

    <div class="print-header">
        <h2>B√ÅO C√ÅO S·ª®C KH·ªéE</h2>
        <p>Ng√†y: <script>document.write(new Date().toLocaleDateString('vi-VN'))</script></p>
        <hr>
    </div>

    <div class="container main-content">
        
        <div class="row mb-4 no-print">
            <div class="col-12">
                <div class="card p-3 border-info border-start border-4">
                    <h6 class="text-info fw-bold mb-3"><i class="bi bi-person-vcard-fill"></i> Th√¥ng Tin C√° Nh√¢n</h6>
                    <div class="row small">
                        <div class="col-6 col-md-3 mb-2">
                            <span class="text-muted">H·ªç t√™n:</span><br>
                            <strong id="pName">--</strong>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <span class="text-muted">Tu·ªïi / Gi·ªõi t√≠nh:</span><br>
                            <strong><span id="pAge">--</span> / <span id="pGender">--</span></strong>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <span class="text-muted">Th·ªÉ tr·∫°ng:</span><br>
                            <strong><span id="pHeight">--</span>m / <span id="pWeight">--</span>kg</strong>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <span class="text-muted">Nh√≥m m√°u:</span><br>
                            <strong class="text-danger" id="pBlood">--</strong>
                        </div>
                        <div class="col-12 mt-1">
                             <span class="text-muted">B·ªánh l√Ω n·ªÅn:</span><br>
                             <span id="pConditions" class="badge bg-warning text-dark text-wrap text-start" style="line-height: 1.4;">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3 no-print">
            <div class="col-6 col-md-3"><button class="tool-btn text-primary" onclick="window.print()"><span>In B√°o C√°o</span><i class="bi bi-printer"></i></button></div>
            <div class="col-6 col-md-3"><button class="tool-btn text-success" data-bs-toggle="modal" data-bs-target="#adminModal"><span>Nh·∫≠p Li·ªáu</span><i class="bi bi-pencil-square"></i></button></div>
            <div class="col-6 col-md-3"><button class="tool-btn text-danger" onclick="generateAIMenu()"><span>Th·ª±c ƒê∆°n AI</span><i class="bi bi-egg-fried"></i></button></div>
            <div class="col-6 col-md-3"><button class="tool-btn text-warning" onclick="checkHealthAI()"><span>Ph√¢n T√≠ch</span><i class="bi bi-activity"></i></button></div>
        </div>

        <div class="row mb-4 search-section">
            <div class="col-md-12">
                <div class="card p-3 border-primary border-1">
                    <h6 class="text-primary"><i class="bi bi-robot"></i> H·ªèi AI calo m√≥n ƒÉn</h6>
                    <div class="input-group input-group-sm">
                        <input type="text" id="aiInput" class="form-control" placeholder="VD: 1 t√¥ ph·ªü b√≤ t√°i..." onkeypress="handleEnter(event)">
                        <button class="btn btn-primary" onclick="askAI()">T√≠nh ngay</button>
                    </div>
                    <div id="aiLoading" class="text-center mt-2" style="display:none"><div class="spinner-border text-primary spinner-border-sm"></div></div>
                    <div id="aiResult" class="mt-2"></div>
                </div>
            </div>
        </div>

        <div id="menuResult" class="card p-3 mb-4 border-warning" style="display:none;">
            <h6 class="text-warning">üí° AI T∆∞ V·∫•n:</h6>
            <div id="menuContent" class="small"></div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6 mb-3 mb-md-0">
                 <div class="card p-3 h-100">
                    <h6 class="card-title text-muted">üî• Calo h√¥m nay</h6>
                    <div class="d-flex justify-content-between align-items-end">
                        <h2 class="fw-bold text-danger mb-0" id="dailyCal">0</h2>
                        <div class="text-end small"><span class="text-muted">M·ª•c ti√™u</span><br><strong id="targetCal">1800</strong></div>
                    </div>
                    <div class="progress mt-2 mb-3" style="height: 8px;"><div id="calProgress" class="progress-bar bg-danger" style="width: 0%"></div></div>
                    
                    <div class="input-group input-group-sm mt-auto">
                        <span class="input-group-text bg-secondary text-white">N·∫°p nhanh</span>
                        <input type="number" id="manualCalInput" class="form-control" placeholder="Nh·∫≠p s·ªë calo...">
                        <button class="btn btn-outline-danger" onclick="addManualCal()">+</button>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                         <button class="btn btn-sm btn-link text-muted p-0" onclick="resetDailyCal()" style="font-size: 0.8rem;">Reset v·ªÅ 0</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 h-100">
                    <h6 class="card-title text-muted">‚öñÔ∏è C√¢n n·∫∑ng (M·ª•c ti√™u: <span id="targetWeightDisplay">--</span> kg)</h6>
                    <div style="height: 150px;">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card p-3">
                    <h6 class="card-title text-primary fw-bold">üìä Di·ªÖn bi·∫øn Gout & Gan</h6>
                    <div style="height: 320px;">
                        <canvas id="labChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div><span class="legend-dot" style="background:#e74c3c"></span>Gout (Tr·ª•c Tr√°i)</div>
                        <div><span class="legend-dot" style="background:#f1c40f"></span>Men Gan (Tr·ª•c Ph·∫£i)</div>
                        <div><i class="bi bi-diamond-fill text-danger"></i> C·∫•p t√≠nh</div>
                        <div><i class="bi bi-star-fill text-success"></i> T·ªët</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4 no-print">
            <div class="col-12">
                <div class="card p-3">
                    <h6 class="card-title text-primary" data-bs-toggle="collapse" data-bs-target="#tableCollapse" style="cursor:pointer">
                        <i class="bi bi-table"></i> B·∫£ng Ch·ªâ S·ªë Chi Ti·∫øt (M·ªü r·ªông) <i class="bi bi-chevron-down"></i>
                    </h6>
                    <div class="collapse" id="tableCollapse">
                        <div class="table-responsive mt-2">
                            <table class="table table-bordered table-hover text-center small" id="compareTable">
                                <thead class="table-light"></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card p-3 h-100 text-center">
                    <h6 class="text-info"><i class="bi bi-droplet-fill"></i> N∆∞·ªõc u·ªëng</h6>
                    <div class="my-3">
                        <h1 class="display-3 fw-bold text-primary mb-0" id="waterCount">0</h1>
                        <p class="small text-muted mb-2">ly (250ml) / M·ª•c ti√™u <span id="waterTargetDisplay">--</span>L</p>
                        <div class="progress" style="height: 10px; border-radius: 5px;">
                            <div id="waterProgress" class="progress-bar bg-primary" style="width: 0%; transition: width 0.5s;"></div>
                        </div>
                        <div class="text-end small text-muted mt-1" id="waterPercentText">0%</div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary rounded-pill btn-sm" onclick="addWater()">+ U·ªëng 1 Ly</button>
                        <button class="btn btn-link text-muted btn-sm p-0" onclick="resetWater()">Reset</button>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card p-3 h-100">
                    <h6 class="text-muted">üìí Nh·∫≠t k√Ω g·∫ßn ƒë√¢y</h6>
                    <div class="table-responsive">
                        <table class="table table-sm small">
                            <thead><tr><th>Ng√†y</th><th>M√≥n</th><th>Calo</th><th>ƒê√°nh gi√°</th></tr></thead>
                            <tbody id="mealTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4 no-print">
            <div class="col-12">
                <div class="card p-3">
                    <h6 class="text-success"><i class="bi bi-clock"></i> L·ªãch tr√¨nh g·ª£i √Ω</h6>
                    <div class="row small text-muted mt-2" id="lifestyleTips"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="no-print py-3 text-center mt-auto border-top" style="background: var(--bg-card); color: var(--text-muted);">
        <small>¬© 2025 Thai Health Tracker</small>
    </footer>

    <div class="modal fade" id="keyModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h6 class="modal-title">C√†i ƒë·∫∑t API</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="password" id="apiKeyInput" class="form-control mb-2" placeholder="Paste API Key..."><button class="btn btn-primary w-100" onclick="saveKey()">L∆∞u Key</button></div></div></div></div>

    <div class="modal fade" id="adminModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h6 class="modal-title">Admin Nh·∫≠p Li·ªáu</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <ul class="nav nav-tabs mb-3" id="myTab"><li class="nav-item"><button class="nav-link active" data-bs-target="#tabCheckup" data-bs-toggle="tab">Kh√°m</button></li><li class="nav-item"><button class="nav-link" data-bs-target="#tabWeight" data-bs-toggle="tab">C√¢n</button></li><li class="nav-item"><button class="nav-link" data-bs-target="#tabMeal" data-bs-toggle="tab">ƒÇn</button></li></ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tabCheckup">
                <input type="date" id="inpDate" class="form-control mb-2">
                <small class="text-primary fw-bold">Gout & Th·∫≠n</small><div class="row g-2 mb-2"><div class="col-4"><input type="number" id="inpUric" class="form-control form-control-sm" placeholder="Uric"></div><div class="col-4"><input type="number" id="inpCre" class="form-control form-control-sm" placeholder="Creatinine"></div><div class="col-4"><input type="number" id="inpEgfr" class="form-control form-control-sm" placeholder="eGFR"></div></div>
                <small class="text-warning fw-bold">Gan</small><div class="row g-2 mb-2"><div class="col-4"><input type="number" id="inpAlt" class="form-control form-control-sm" placeholder="ALT"></div><div class="col-4"><input type="number" id="inpAst" class="form-control form-control-sm" placeholder="AST"></div><div class="col-4"><input type="number" id="inpGgt" class="form-control form-control-sm" placeholder="GGT"></div></div>
                <small class="text-success fw-bold">M·ª° M√°u</small><div class="row g-2 mb-2"><div class="col-3"><input type="number" id="inpChol" class="form-control form-control-sm" placeholder="Cholest."></div><div class="col-3"><input type="number" id="inpTri" class="form-control form-control-sm" placeholder="Trigly."></div><div class="col-3"><input type="number" id="inpHdl" class="form-control form-control-sm" placeholder="HDL"></div><div class="col-3"><input type="number" id="inpGlu" class="form-control form-control-sm" placeholder="Glucose"></div></div>
                <small class="text-secondary fw-bold">M√°u</small><div class="row g-2"><div class="col-3"><input type="number" id="inpHgb" class="form-control form-control-sm" placeholder="HGB"></div><div class="col-3"><input type="number" id="inpRbc" class="form-control form-control-sm" placeholder="RBC"></div><div class="col-3"><input type="number" id="inpWbc" class="form-control form-control-sm" placeholder="WBC"></div><div class="col-3"><input type="number" id="inpPlt" class="form-control form-control-sm" placeholder="PLT"></div></div>
                <input type="text" id="inpNote" class="form-control mt-3" placeholder="Ghi ch√∫ s·ª± ki·ªán...">
                <button class="btn btn-primary w-100 mt-3" onclick="genCheckupJSON()">T·∫°o JSON</button>
            </div>
            <div class="tab-pane fade" id="tabWeight"><input type="date" id="inpWDate" class="form-control mb-2"><input type="number" id="inpWeight" class="form-control mb-2" placeholder="kg"><button class="btn btn-success w-100" onclick="genWeightJSON()">T·∫°o JSON</button></div>
            <div class="tab-pane fade" id="tabMeal"><input type="date" id="inpMDate" class="form-control mb-2"><textarea id="inpMContent" class="form-control mb-2" placeholder="M√≥n..."></textarea><input type="number" id="inpMCal" class="form-control mb-2" placeholder="Calo"><textarea id="inpMEval" class="form-control mb-2" placeholder="ƒê√°nh gi√°..."></textarea><button class="btn btn-warning w-100" onclick="genMealJSON()">T·∫°o JSON</button></div>
        </div>
        <textarea id="jsonOutput" class="form-control mt-3 small" rows="3" readonly style="background: var(--input-bg); color: var(--text-main);"></textarea>
    </div></div></div></div>

    <script>
        let foodDB = [], healthProfile = {};
        let labChartInstance = null, weightChartInstance = null; // Store chart instances
        const CUP_SIZE = 0.25; let dailyTarget = 2.5; 
        const MODEL_LIST = ["gemini-2.5-flash", "gemini-2.0-flash-001", "gemini-2.0-flash-lite-001"];

        // --- THEME MANAGEMENT ---
        function initTheme() {
            const stored = localStorage.getItem('theme') || 'light';
            setTheme(stored);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            setTheme(next);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const btn = document.getElementById('themeBtn');
            if(theme === 'dark') {
                btn.innerHTML = '<i class="bi bi-sun-fill"></i>';
                Chart.defaults.color = '#e0e0e0';
                Chart.defaults.borderColor = '#444';
            } else {
                btn.innerHTML = '<i class="bi bi-moon-fill"></i>';
                Chart.defaults.color = '#666';
                Chart.defaults.borderColor = '#ddd';
            }
            // Re-render charts to apply new colors
            if(healthProfile.lastCheckup) {
                fetch('data.json').then(r=>r.json()).then(data => {
                    // Need to re-sort same as initial load to keep consistency
                    data.medical_checkups.sort((a, b) => new Date(a.date) - new Date(b.date));
                    data.weight_log.sort((a, b) => new Date(a.date) - new Date(b.date));
                    renderLabChart(data.medical_checkups);
                    renderWeightChart(data.weight_log, data.profile.target_weight);
                });
            }
        }

        initTheme(); // Run immediately

        fetch('data.json').then(r => r.json()).then(data => {
            foodDB = data.food_database;
            
            data.medical_checkups.sort((a, b) => new Date(a.date) - new Date(b.date));
            data.weight_log.sort((a, b) => new Date(a.date) - new Date(b.date));

            healthProfile = {
                conditions: data.profile.conditions.join(", "),
                lastCheckup: data.medical_checkups[data.medical_checkups.length - 1],
                targetCal: data.profile.daily_calories_target || 1800
            };
            
            // Render Personal Info
            document.getElementById('headerName').innerText = data.profile.name;
            document.getElementById('pName').innerText = data.profile.name;
            const currentYear = new Date().getFullYear();
            const age = currentYear - parseInt(data.profile.dob);
            document.getElementById('pAge').innerText = age;
            document.getElementById('pGender').innerText = data.profile.gender;
            document.getElementById('pHeight').innerText = data.profile.height;
            const lastWeight = data.weight_log.length > 0 ? data.weight_log[data.weight_log.length - 1].value : "--";
            document.getElementById('pWeight').innerText = lastWeight;
            document.getElementById('pBlood').innerText = data.profile.blood_type;
            document.getElementById('pConditions').innerText = healthProfile.conditions;

            document.getElementById('targetCal').innerText = healthProfile.targetCal;
            document.getElementById('targetWeightDisplay').innerText = data.profile.target_weight;
            
            renderLabChart(data.medical_checkups);
            renderWeightChart(data.weight_log, data.profile.target_weight);
            renderCompareTable(data.medical_checkups);
            renderMeals(data.meal_logs);
            renderLifestyle(data.lifestyle_tips);
            
            calculateTarget(data.medical_checkups[data.medical_checkups.length - 1]);
            loadWater(); loadDailyCalories();

            const key = localStorage.getItem('geminiKey');
            if(key) document.getElementById('apiKeyInput').value = key;
        });

        // --- AI ENGINE ---
        async function callGemini(prompt) {
            const key = localStorage.getItem('geminiKey');
            if(!key) { alert('Nh·∫≠p API Key!'); return null; }
            document.getElementById('aiLoading').style.display = 'block';
            let finalResult = null;
            
            for (let modelName of MODEL_LIST) {
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
                    const res = await fetch(url, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    if (data.candidates && data.candidates.length > 0) {
                        finalResult = data.candidates[0].content.parts[0].text;
                        document.getElementById('modelStatus').innerText = `‚úÖ ${modelName}`;
                        break;
                    }
                } catch(e) { console.error(e); }
            }
            document.getElementById('aiLoading').style.display = 'none';
            if (!finalResult) alert('AI Error. Ki·ªÉm tra Key/Quota.');
            return finalResult;
        }

        async function askAI() {
            const q = document.getElementById('aiInput').value; if(!q) return;
            const prompt = `ƒê√≥ng vai b√°c sƒ© dinh d∆∞·ª°ng. Ph√¢n t√≠ch m√≥n: "${q}". B·ªánh l√Ω: ${healthProfile.conditions}. Tr·∫£ v·ªÅ JSON (kh√¥ng markdown): {"name": "T√™n chu·∫©n", "calories": s·ªë_nguy√™n, "portion": "kh·∫©u ph·∫ßn", "status": "green/yellow/red", "reason": "l√Ω do ng·∫Øn"}`;
            const res = await callGemini(prompt);
            if(res) {
                try {
                    const d = JSON.parse(res.replace(/```json|```/g, '').trim());
                    const c = d.status=='green'?'success':(d.status=='yellow'?'warning':'danger');
                    document.getElementById('aiResult').innerHTML = `<div class="alert alert-${c} p-2"><strong>${d.name}</strong> <span class="badge bg-dark">${d.calories} kcal</span><br><small>${d.reason}</small><button class="btn btn-sm btn-outline-dark w-100 mt-1" onclick="addTempCal(${d.calories})">+ Th√™m Calo</button></div>`;
                } catch(e) { document.getElementById('aiResult').innerHTML = `<div class="alert alert-secondary small">${res}</div>`; }
            }
        }

        // --- CHARTING ---
        function renderLabChart(logs) {
            const ctx = document.getElementById('labChart').getContext('2d');
            if(labChartInstance) labChartInstance.destroy(); // Destroy old chart before creating new one

            const pStyles = logs.map(l => { const n=(l.note||'').toLowerCase(); if(n.includes('t·ªët')||n.includes('h·ªìi ph·ª•c')) return 'star'; if(n.includes('c·∫•p')||n.includes('cao')||n.includes('tƒÉng')) return 'rectRot'; return 'circle'; });
            const pColors = logs.map(l => { const n=(l.note||'').toLowerCase(); if(n.includes('c·∫•p')||n.includes('tƒÉng')) return '#e74c3c'; if(n.includes('t·ªët')) return '#27ae60'; return '#e74c3c'; });
            const pSizes = logs.map(l => (l.note && l.note.length>5)?8:4);

            labChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [
                        { label: 'Gout', data: logs.map(l => l.uric_acid), borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill:true, yAxisID:'y', pointStyle:pStyles, pointBackgroundColor:pColors, pointRadius:pSizes, tension:0.4 },
                        { label: 'Gan (ALT)', data: logs.map(l => l.alt_liver), borderColor: '#f1c40f', borderDash:[5,5], yAxisID:'y1', pointRadius:0, tension:0.4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { type:'linear', position:'left', title:{display:true,text:'Gout (¬µmol/L)'}, suggestedMin:200, suggestedMax:650 },
                        y1: { type:'linear', position:'right', title:{display:true,text:'Gan (U/L)'}, grid:{drawOnChartArea:false}, suggestedMin:0, suggestedMax:150 }
                    },
                    plugins: { legend: {display:false}, tooltip: {callbacks:{footer: (items) => {const n=logs[items[0].dataIndex].note; return n?'üìå '+n:'';}}} }
                }
            });
        }

        function renderWeightChart(logs, target) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            if(weightChartInstance) weightChartInstance.destroy();

            const gradient = ctx.createLinearGradient(0,0,0,200); gradient.addColorStop(0,'rgba(52,152,219,0.4)'); gradient.addColorStop(1,'rgba(52,152,219,0.0)');
            weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [
                        { label:'C√¢n n·∫∑ng', data:logs.map(l=>l.value), borderColor:'#3498db', backgroundColor:gradient, fill:true, tension:0.4, pointRadius:4 },
                        { label:'M·ª•c ti√™u', data:Array(logs.length).fill(target), borderColor:'#2ecc71', borderDash:[5,5], pointRadius:0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { suggestedMin: 58, suggestedMax: 80 }, x:{grid:{display:false}} },
                    plugins: { legend:{display:false} }
                }
            });
        }

        function renderCompareTable(logs) {
            const thead = document.querySelector('#compareTable thead');
            const tbody = document.querySelector('#compareTable tbody');
            let hHTML = `<tr><th class="text-start" style="width: 35%;">Ch·ªâ s·ªë & √ù nghƒ©a</th><th>Ng∆∞·ª°ng</th>`;
            logs.forEach(l => hHTML += `<th>${l.date}</th>`);
            thead.innerHTML = hHTML + '</tr>';
            const metrics = [
                {group:true, name:'GOUT & TH·∫¨N'},
                {n:'Acid Uric', k:'uric_acid', u:'¬µmol/L', max:420, d:'T√°c nh√¢n g√¢y b·ªánh Gout.'}, 
                {n:'Creatinine', k:'creatinine', u:'¬µmol/L', min:62, max:120, d:'ƒê√°nh gi√° ch·ª©c nƒÉng th·∫≠n.'}, 
                {n:'eGFR', k:'egfr', u:'ml/min', min:90, d:'ƒê·ªô l·ªçc c·∫ßu th·∫≠n. <60 l√† suy th·∫≠n.'},
                {group:true, name:'GAN (MEN GAN)'},
                {n:'ALT (GPT)', k:'alt_liver', u:'U/L', max:40, d:'Men gan ƒë·∫∑c hi·ªáu. TƒÉng khi gan t·ªïn th∆∞∆°ng.'}, 
                {n:'AST (GOT)', k:'ast_liver', u:'U/L', max:37, d:'Men gan.'}, 
                {n:'GGT', k:'ggt_liver', u:'U/L', max:50, d:'Nh·∫°y c·∫£m v·ªõi r∆∞·ª£u bia.'},
                {group:true, name:'M·ª† M√ÅU & ƒê∆Ø·ªúNG'},
                {n:'Cholesterol', k:'cholesterol', u:'mmol/L', max:5.2, d:'M·ª° m√°u t·ªïng ph·∫ßn.'}, 
                {n:'Triglyceride', k:'triglyceride', u:'mmol/L', max:1.88, d:'Ch·∫•t b√©o trung t√≠nh.'}, 
                {n:'HDL-C', k:'hdl', u:'mmol/L', min:0.9, d:'M·ª° t·ªët. C√†ng cao c√†ng t·ªët.'},
                {n:'Glucose', k:'glucose', u:'mmol/L', max:6.4, d:'ƒê∆∞·ªùng huy·∫øt l√∫c ƒë√≥i.'},
                {group:true, name:'M√ÅU'},
                {n:'WBC', k:'wbc', u:'K/¬µL', min:4.5, max:9.0, d:'B·∫°ch c·∫ßu (Mi·ªÖn d·ªãch).'}, 
                {n:'RBC', k:'rbc', u:'M/¬µL', min:3.7, max:5.2, d:'H·ªìng c·∫ßu (Oxy).'}, 
                {n:'HGB', k:'hgb', u:'g/dL', min:9.0, max:16.5, d:'Huy·∫øt s·∫Øc t·ªë.'},
                {n:'PLT', k:'plt', u:'K/¬µL', min:150, max:350, d:'Ti·ªÉu c·∫ßu (ƒê√¥ng m√°u).'}
            ];
            tbody.innerHTML = '';
            metrics.forEach(m => {
                if(m.group) {
                    tbody.innerHTML += `<tr style="background: var(--border-color);"><td colspan="${logs.length+2}" class="fw-bold text-primary text-uppercase small ps-3 pt-3">${m.name}</td></tr>`;
                } else {
                    let range = m.min && m.max ? `${m.min}-${m.max}` : (m.max ? `< ${m.max}` : `> ${m.min}`);
                    let row = `<tr>
                        <td class="text-start ps-3">
                            <div class="fw-bold">${m.n} <span class="opacity-75 fw-normal" style="font-size:0.85em">(${m.u})</span></div>
                            <div class="opacity-75 fst-italic mt-1" style="font-size: 0.75rem;">${m.d}</div>
                        </td>
                        <td class="small align-middle opacity-75"><em>${range}</em></td>`;
                    logs.forEach(l => {
                        let v = l[m.k] !== undefined && l[m.k] !== null ? l[m.k] : '-';
                        let cls = 'align-middle';
                        if(typeof v === 'number') {
                            if ((m.max && v > m.max) || (m.min && v < m.min)) cls += ' text-danger fw-bold';
                            else if (m.k === 'hdl' && v >= m.min) cls += ' text-success fw-bold';
                        }
                        row += `<td class="${cls}">${v}</td>`;
                    });
                    tbody.innerHTML += row + '</tr>';
                }
            });
        }

        function loadWater() { const t=new Date().toLocaleDateString(); if(localStorage.getItem('wDate')!=t){localStorage.setItem('wDate',t);localStorage.setItem('wCount',0);} updateWaterUI(parseInt(localStorage.getItem('wCount'))||0); }
        function addWater() { let c=(parseInt(localStorage.getItem('wCount'))||0)+1; localStorage.setItem('wCount',c); updateWaterUI(c); }
        function resetWater() { if(confirm('Reset?')){localStorage.setItem('wCount',0); updateWaterUI(0);} }
        function updateWaterUI(c) {
            document.getElementById('waterCount').innerText = c;
            const pct = Math.min((c * CUP_SIZE / dailyTarget) * 100, 100);
            const bar = document.getElementById('waterProgress');
            if(bar) { bar.style.width=pct+'%'; if(pct>=100){bar.classList.remove('bg-primary');bar.classList.add('bg-success');}else{bar.classList.add('bg-primary');bar.classList.remove('bg-success');} }
            document.getElementById('waterPercentText').innerText = Math.round(pct)+'%';
        }

        function renderMeals(logs) { document.getElementById('mealTable').innerHTML=logs.slice().reverse().slice(0,5).map(l=>`<tr><td>${l.date}</td><td>${l.content}</td><td>${l.calories||'-'}</td><td>${l.evaluation}</td></tr>`).join(''); }
        function renderLifestyle(t) { document.getElementById('lifestyleTips').innerHTML=`<div class="col-3">üåÖ ${t.morning}</div><div class="col-3">üç± ${t.eating}</div><div class="col-3">üåô ${t.evening}</div><div class="col-3">üèÉ ${t.exercise}</div>`; }
        function loadDailyCalories() { const t=new Date().toLocaleDateString(); if(localStorage.getItem('cDate')!=t){localStorage.setItem('cDate',t);localStorage.setItem('dCal',0);} updateCalUI(parseInt(localStorage.getItem('dCal'))); }
        function addTempCal(n) { let c=parseInt(localStorage.getItem('dCal'))+n; localStorage.setItem('dCal',c); updateCalUI(c); }
        function addManualCal() { const v = parseInt(document.getElementById('manualCalInput').value); if(v > 0) { addTempCal(v); document.getElementById('manualCalInput').value=''; } }
        function resetDailyCal() { localStorage.setItem('dCal',0); updateCalUI(0); }
        function updateCalUI(v) { document.getElementById('dailyCal').innerText=v; document.getElementById('calProgress').style.width=Math.min((v/healthProfile.targetCal)*100,100)+'%'; }
        function calculateTarget(l) { dailyTarget = (l.uric_acid>400||l.alt_liver>40)?3.0:2.5; document.getElementById('waterTargetDisplay').innerText=dailyTarget; }
        function genCheckupJSON() { const o={date:document.getElementById('inpDate').value, uric_acid:parseFloat(document.getElementById('inpUric').value), alt_liver:parseFloat(document.getElementById('inpAlt').value), ast_liver:parseFloat(document.getElementById('inpAst').value), ggt_liver:parseFloat(document.getElementById('inpGgt').value), creatinine:parseFloat(document.getElementById('inpCre').value), egfr:parseFloat(document.getElementById('inpEgfr').value), cholesterol:parseFloat(document.getElementById('inpChol').value), triglyceride:parseFloat(document.getElementById('inpTri').value), hdl:parseFloat(document.getElementById('inpHdl').value), glucose:parseFloat(document.getElementById('inpGlu').value), hgb:parseFloat(document.getElementById('inpHgb').value), rbc:parseFloat(document.getElementById('inpRbc').value), wbc:parseFloat(document.getElementById('inpWbc').value), plt:parseFloat(document.getElementById('inpPlt').value), note:document.getElementById('inpNote').value}; showJSON(o); }
        function genWeightJSON() { showJSON({date:document.getElementById('inpWDate').value, value:parseFloat(document.getElementById('inpWeight').value)}); }
        function genMealJSON() { showJSON({date:document.getElementById('inpMDate').value, content:document.getElementById('inpMContent').value, calories:parseFloat(document.getElementById('inpMCal').value), evaluation:document.getElementById('inpMEval').value}); }
        function showJSON(o) { const t=document.getElementById('jsonOutput'); t.value=JSON.stringify(o,null,2)+","; t.select(); document.execCommand('copy'); alert('ƒê√£ copy!'); }
        function saveKey() { localStorage.setItem('geminiKey', document.getElementById('apiKeyInput').value); location.reload(); }
        function handleEnter(e) { if(e.key==='Enter') askAI(); }
        async function generateAIMenu() { const r=await callGemini(`G·ª£i √Ω th·ª±c ƒë∆°n 1 ng√†y cho: ${healthProfile.conditions}. Calo: ${healthProfile.targetCal}. Markdown.`); if(r){document.getElementById('menuResult').style.display='block';document.getElementById('menuContent').innerHTML=marked.parse(r);} }
        async function checkHealthAI() { const r=await callGemini(`Ph√¢n t√≠ch ch·ªâ s·ªë: ${JSON.stringify(healthProfile.lastCheckup)}. Markdown.`); if(r){document.getElementById('menuResult').style.display='block';document.getElementById('menuContent').innerHTML=marked.parse(r);} }
    </script>
</body>
</html>