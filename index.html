<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Health AI Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        /* Giao di·ªán Clean & Modern */
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .main-content { flex: 1; }
        
        /* Cards hi·ªáu ·ª©ng n·ªïi */
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); transition: transform 0.2s; margin-bottom: 20px; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(0,0,0,0.06); }
        
        /* Header Gradient */
        .header-bg { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: white; padding: 40px 0 30px; border-radius: 0 0 30px 30px; margin-bottom: 30px; }
        
        /* Buttons c√¥ng c·ª• */
        .tool-btn { border-radius: 12px; padding: 15px; font-weight: 600; border: none; width: 100%; text-align: left; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: all 0.2s; }
        .tool-btn:active { transform: scale(0.96); }
        
        /* AI Elements */
        .ai-badge { background: linear-gradient(45deg, #ff00cc, #333399); color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.7em; font-weight: bold; letter-spacing: 0.5px; box-shadow: 0 0 10px rgba(51, 51, 153, 0.5); }
        .ai-loading { display: none; }
        
        /* Footer */
        footer { background-color: #fff; border-top: 1px solid #eaeaea; padding: 20px 0; text-align: center; margin-top: auto; font-size: 0.9rem; color: #666; }
        .heart-beat { animation: beat 1s infinite alternate; display: inline-block; color: #e74c3c; }
        @keyframes beat { to { transform: scale(1.1); } }
    </style>
</head>
<body>

    <div class="header-bg text-center">
        <div class="container">
            <h1 class="fw-bold mb-1">Nguy·ªÖn Anh Th√°i</h1>
            <p class="opacity-75 mb-2">Personal Health Dashboard <span class="ai-badge">‚ö° AI Powered</span></p>
            
            <button class="btn btn-sm btn-outline-secondary text-white border-white rounded-pill mt-2 px-3" data-bs-toggle="modal" data-bs-target="#keyModal">
                <i class="bi bi-gear-fill"></i> C√†i ƒë·∫∑t Gemini API
            </button>
        </div>
    </div>

    <div class="container main-content">
        
        <div class="row mb-4">
            <div class="col-6 col-md-3 mb-2">
                <button class="tool-btn bg-white text-primary" onclick="window.print()">
                    <span><i class="bi bi-printer-fill me-2"></i>B√°o c√°o Y t·∫ø</span>
                </button>
            </div>
            <div class="col-6 col-md-3 mb-2">
                <button class="tool-btn bg-white text-success" data-bs-toggle="modal" data-bs-target="#adminModal">
                    <span><i class="bi bi-database-add me-2"></i>Nh·∫≠p li·ªáu</span>
                </button>
            </div>
            <div class="col-6 col-md-3 mb-2">
                <button class="tool-btn bg-white text-danger" onclick="generateAIMenu()">
                    <span><i class="bi bi-stars me-2"></i>AI Th·ª±c ƒë∆°n</span>
                </button>
            </div>
            <div class="col-6 col-md-3 mb-2">
                <button class="tool-btn bg-white text-warning" onclick="checkHealthAI()">
                    <span><i class="bi bi-activity me-2"></i>AI T∆∞ v·∫•n</span>
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card p-4">
                    <label class="fw-bold mb-2 text-primary"><i class="bi bi-robot"></i> H·ªèi Gemini v·ªÅ th·ª±c ph·∫©m:</label>
                    <div class="input-group input-group-lg">
                        <input type="text" id="foodSearch" class="form-control border-primary" placeholder="V√≠ d·ª•: B√∫n b√≤, Tr√† s·ªØa, Canh chua..." onkeypress="handleEnter(event)">
                        <button class="btn btn-primary px-4" onclick="searchWithAI()">
                            <i class="bi bi-send-fill"></i> H·ªèi ngay
                        </button>
                    </div>
                    
                    <div id="aiLoading" class="text-center mt-3 ai-loading">
                        <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                        <small class="text-primary fw-bold ms-2">Gemini ƒëang ph√¢n t√≠ch...</small>
                    </div>
                    
                    <div id="searchResult" class="mt-3"></div>
                    
                    <div id="menuResult" class="alert alert-light border mt-3" style="display:none;">
                        <h5 class="text-primary fw-bold"><i class="bi bi-stars"></i> K·∫øt qu·∫£ t·ª´ Gemini:</h5>
                        <hr>
                        <div id="menuContent" class="small"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-7">
                <div class="card p-3 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0"><i class="bi bi-graph-up text-danger"></i> Ch·ªâ s·ªë X√©t Nghi·ªám</h5>
                        <small class="text-muted">ƒê∆∞·ªùng n√©t ƒë·ª©t l√† ng∆∞·ª°ng an to√†n</small>
                    </div>
                    <canvas id="labChart"></canvas>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-3 h-100">
                    <h5 class="fw-bold mb-3"><i class="bi bi-speedometer2 text-success"></i> C√¢n n·∫∑ng & M·ª•c ti√™u</h5>
                    <canvas id="weightChart"></canvas>
                    <div class="text-center mt-3">
                        <span class="badge bg-success p-2">M·ª•c ti√™u: <span id="targetWeightDisplay">--</span> kg</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
             <div class="col-12">
                <div class="card p-3">
                    <h5 class="fw-bold"><i class="bi bi-journal-bookmark-fill text-info"></i> Nh·∫≠t k√Ω S·ª©c kh·ªèe</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>Ng√†y</th><th>N·ªôi dung</th><th>ƒê√°nh gi√°</th></tr></thead>
                            <tbody id="mealTable"></tbody>
                        </table>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p class="mb-1 fw-bold">¬© 2025 Thai Health Tracker Project</p>
            <small>
                Ph√°t tri·ªÉn b·ªüi <span class="text-primary">Nguy·ªÖn Anh Th√°i</span> & <span class="text-primary">Gemini AI</span> 
                <span class="ai-badge ms-1">‚ö° AI Powered</span>
            </small>
            <div class="mt-2 text-muted" style="font-size: 0.8em;">
                Made with <i class="bi bi-heart-fill heart-beat"></i> for a better health.
            </div>
        </div>
    </footer>

    <div class="modal fade" id="keyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">üîë C√†i ƒë·∫∑t Gemini API</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">
                        API Key gi√∫p k√≠ch ho·∫°t t√≠nh nƒÉng AI (G·ª£i √Ω m√≥n, Ph√¢n t√≠ch th·ª±c ph·∫©m). 
                        Key ƒë∆∞·ª£c l∆∞u <strong>c·ª•c b·ªô</strong> tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n.
                    </div>
                    <label class="form-label">D√°n API Key v√†o ƒë√¢y:</label>
                    <input type="password" id="apiKeyInput" class="form-control mb-2" placeholder="AIzaSy...">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showKey">
                        <label class="form-check-label small" for="showKey">Hi·ªán k√Ω t·ª±</label>
                    </div>
                    <button class="btn btn-primary w-100" onclick="saveKey()">L∆∞u c·∫•u h√¨nh</button>
                    <div class="text-center mt-3">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="small text-decoration-none">Ch∆∞a c√≥ Key? L·∫•y mi·ªÖn ph√≠ t·∫°i Google AI Studio ‚Üó</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">üõ†Ô∏è C√¥ng c·ª• Nh·∫≠p li·ªáu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-pills nav-fill mb-3" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCheckup">X√©t nghi·ªám</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabWeight">C√¢n n·∫∑ng</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tabCheckup">
                            <input type="date" id="inpDate" class="form-control mb-2">
                            <div class="row g-2">
                                <div class="col-6"><input type="number" id="inpUric" class="form-control" placeholder="Acid Uric"></div>
                                <div class="col-6"><input type="number" id="inpAlt" class="form-control" placeholder="Men gan (ALT)"></div>
                                <div class="col-6"><input type="number" id="inpCre" class="form-control" placeholder="Creatinine"></div>
                                <div class="col-6"><input type="number" id="inpEgfr" class="form-control" placeholder="eGFR (Th·∫≠n)"></div>
                            </div>
                            <button class="btn btn-success w-100 mt-3" onclick="genCheckupJSON()">T·∫°o Code JSON</button>
                        </div>
                        <div class="tab-pane fade" id="tabWeight">
                            <input type="date" id="inpWDate" class="form-control mb-2">
                            <input type="number" id="inpWeight" class="form-control mb-2" placeholder="S·ªë kg (VD: 73.5)">
                            <button class="btn btn-primary w-100 mt-3" onclick="genWeightJSON()">T·∫°o Code JSON</button>
                        </div>
                    </div>
                    <textarea id="jsonOutput" class="form-control mt-3 bg-light font-monospace" rows="3" readonly placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        let foodDB = [];
        let healthProfile = {};
        
        // --- KH·ªûI T·∫†O ---
        fetch('data.json').then(r => r.json()).then(data => {
            fullData = data;
            foodDB = data.food_database;
            healthProfile = {
                conditions: data.profile.conditions.join(", "),
                lastCheckup: data.medical_checkups[data.medical_checkups.length - 1]
            };
            
            document.getElementById('targetWeightDisplay').innerText = data.profile.target_weight;
            
            renderLabChart(data.medical_checkups);
            renderWeightChart(data.weight_log, data.profile.target_weight);
            renderMeals(data.meal_logs);
            
            // Ki·ªÉm tra Key
            const key = localStorage.getItem('geminiKey');
            if(key) document.getElementById('apiKeyInput').value = key;
        });

        // --- X·ª¨ L√ù API KEY ---
        document.getElementById('showKey').addEventListener('change', function() {
            document.getElementById('apiKeyInput').type = this.checked ? 'text' : 'password';
        });
        function saveKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) {
                localStorage.setItem('geminiKey', key);
                alert('ƒê√£ l∆∞u API Key th√†nh c√¥ng!');
                bootstrap.Modal.getInstance(document.getElementById('keyModal')).hide();
            }
        }

        // --- G·ªåI GEMINI (H√†m l√µi) ---
        async function callGemini(prompt) {
            const key = localStorage.getItem('geminiKey');
            if(!key) {
                const modal = new bootstrap.Modal(document.getElementById('keyModal'));
                modal.show();
                return null;
            }

            document.getElementById('aiLoading').style.display = 'block';
            document.getElementById('menuResult').style.display = 'none';
            document.getElementById('searchResult').innerHTML = '';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                document.getElementById('aiLoading').style.display = 'none';
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                document.getElementById('aiLoading').style.display = 'none';
                alert('L·ªói k·∫øt n·ªëi AI: ' + error);
                return null;
            }
        }

        // --- C√ÅC T√çNH NƒÇNG AI ---
        async function searchWithAI() {
            const query = document.getElementById('foodSearch').value;
            if(!query) return;
            
            // Check DB tr∆∞·ªõc
            const local = foodDB.find(f => f.name.toLowerCase().includes(query.toLowerCase()));
            if(local) {
                let color = local.status === 'green' ? 'success' : (local.status === 'yellow' ? 'warning' : 'danger');
                document.getElementById('searchResult').innerHTML = 
                    `<div class="alert alert-${color}"><strong>(C√≥ s·∫µn) ${local.name}</strong>: ${local.reason}</div>`;
                return;
            }

            // H·ªèi AI
            const prompt = `T√¥i b·ªã: ${healthProfile.conditions}. Ch·ªâ s·ªë: Acid Uric ${healthProfile.lastCheckup.uric_acid}, Men gan ${healthProfile.lastCheckup.alt_liver}, eGFR ${healthProfile.lastCheckup.egfr}. 
            ƒê√°nh gi√° m√≥n: "${query}". Tr·∫£ v·ªÅ JSON: {"status": "green/yellow/red", "name": "${query}", "reason": "ng·∫Øn g·ªçn"}`;
            
            const res = await callGemini(prompt);
            if(res) {
                try {
                    const json = JSON.parse(res.replace(/```json|```/g, '').trim());
                    let color = json.status === 'green' ? 'success' : (json.status === 'yellow' ? 'warning' : 'danger');
                    let icon = json.status === 'green' ? 'üü¢ N√™n ƒÉn' : (json.status === 'yellow' ? 'üü° H·∫°n ch·∫ø' : 'üî¥ Tr√°nh xa');
                    document.getElementById('searchResult').innerHTML = 
                        `<div class="alert alert-${color}"><strong>${icon} ${json.name}</strong><br>${json.reason}</div>`;
                } catch(e) {
                    document.getElementById('searchResult').innerHTML = `<div class="alert alert-light border">${marked.parse(res)}</div>`;
                }
            }
        }

        async function generateAIMenu() {
            const prompt = `G·ª£i √Ω th·ª±c ƒë∆°n 1 ng√†y (S√°ng/Tr∆∞a/Chi·ªÅu) cho ng∆∞·ªùi b·ªã Gout, Men gan cao, Tr√†o ng∆∞·ª£c. M√≥n Vi·ªát Nam, b√¨nh d√¢n. ƒê·ªãnh d·∫°ng Markdown.`;
            const res = await callGemini(prompt);
            if(res) {
                document.getElementById('menuResult').style.display = 'block';
                document.getElementById('menuContent').innerHTML = marked.parse(res);
            }
        }
        
        async function checkHealthAI() {
            const prompt = `D·ª±a tr√™n ch·ªâ s·ªë: Uric ${healthProfile.lastCheckup.uric_acid}, ALT ${healthProfile.lastCheckup.alt_liver}, eGFR ${healthProfile.lastCheckup.egfr}. H√£y ƒë∆∞a ra 3 l·ªùi khuy√™n y t·∫ø quan tr·ªçng nh·∫•t ngay l√∫c n√†y.`;
            const res = await callGemini(prompt);
            if(res) {
                document.getElementById('menuResult').style.display = 'block';
                document.getElementById('menuContent').innerHTML = marked.parse(res);
            }
        }

        function handleEnter(e) { if(e.key === 'Enter') searchWithAI(); }

        // --- ADMIN TOOLS ---
        function genCheckupJSON() {
            const obj = {
                date: document.getElementById('inpDate').value,
                uric_acid: parseFloat(document.getElementById('inpUric').value),
                alt_liver: parseFloat(document.getElementById('inpAlt').value),
                creatinine: parseFloat(document.getElementById('inpCre').value),
                egfr: parseFloat(document.getElementById('inpEgfr').value),
                note: "C·∫≠p nh·∫≠t m·ªõi"
            };
            copyJSON(JSON.stringify(obj, null, 2) + ",");
        }
        function genWeightJSON() {
            const obj = { date: document.getElementById('inpWDate').value, value: parseFloat(document.getElementById('inpWeight').value) };
            copyJSON(JSON.stringify(obj, null, 2) + ",");
        }
        function copyJSON(str) {
            const out = document.getElementById('jsonOutput');
            out.value = str; out.select(); document.execCommand('copy');
            alert('ƒê√£ copy JSON! H√£y d√°n v√†o file data.json');
        }

        // --- CHARTS ---
        function renderLabChart(logs) {
            const ctx = document.getElementById('labChart').getContext('2d');
            const labels = logs.map(l => l.date);
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Acid Uric', data: logs.map(l => l.uric_acid), borderColor: '#e74c3c', tension:0.3, yAxisID:'y' },
                        { label: 'Men gan (ALT)', data: logs.map(l => l.alt_liver), borderColor: '#f39c12', tension:0.3, yAxisID:'y1' },
                        { label: 'Th·∫≠n (eGFR)', data: logs.map(l => l.egfr), borderColor: '#2ecc71', borderDash:[5,5], tension:0.3, yAxisID:'y1' },
                        { label: 'Ng∆∞·ª°ng Gout (420)', data: Array(logs.length).fill(420), borderColor: 'rgba(231,76,60,0.3)', borderDash:[10,5], pointRadius:0, yAxisID:'y' }
                    ]
                },
                options: { responsive: true, scales: { y: {position:'left'}, y1: {position:'right', grid:{drawOnChartArea:false}} } }
            });
        }
        function renderWeightChart(logs, target) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [
                        { label: 'C√¢n n·∫∑ng (kg)', data: logs.map(l => l.value), borderColor: '#3498db', backgroundColor:'rgba(52,152,219,0.1)', fill:true, tension:0.3 },
                        { label: 'M·ª•c ti√™u', data: Array(logs.length).fill(target), borderColor: '#27ae60', borderDash:[5,5], pointRadius:0 }
                    ]
                }
            });
        }
        function renderMeals(logs) {
             const tbody = document.getElementById('mealTable');
             tbody.innerHTML = '';
             logs.slice().reverse().slice(0,10).forEach(log => {
                tbody.innerHTML += `<tr><td><small>${log.date}</small></td><td>${log.content}</td><td><span class="badge bg-success bg-opacity-10 text-success">${log.evaluation}</span></td></tr>`;
            });
        }
    </script>
</body>
</html>