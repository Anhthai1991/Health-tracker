<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Health Ultimate SuperApp 2.5</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3c72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        .main-content { flex: 1; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .header-gradient { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: white; padding: 40px 0 30px; border-radius: 0 0 30px 30px; margin-bottom: 30px; }
        .tool-btn { border-radius: 12px; padding: 15px; font-weight: 600; border: none; width: 100%; margin-bottom: 10px; text-align: left; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-loading { display: none; }
        .ai-badge { background: linear-gradient(45deg, #ff0099, #493240); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; margin-left: 5px; }
        .water-section { background: white; border-radius: 16px; padding: 20px; text-align: center; }
        
        /* Style cho bi·ªÉu ƒë·ªì s·ª± ki·ªán */
        .chart-legend { font-size: 0.8rem; color: #666; text-align: center; margin-top: 5px; }
        
        @media print {
            .no-print, .header-gradient, footer, .tool-btn, .search-section, .water-section { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; }
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
            body { background: white; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>

    <div class="header-gradient text-center no-print">
        <div class="container">
            <h1 class="fw-bold">Nguy·ªÖn Anh Th√°i <span class="ai-badge">Gemini 2.5</span></h1>
            <p class="opacity-75">Gout ‚Ä¢ Men Gan ‚Ä¢ Th·∫≠n ‚Ä¢ Tr√†o ng∆∞·ª£c</p>
            <button class="btn btn-sm btn-outline-light mt-2 rounded-pill" data-bs-toggle="modal" data-bs-target="#keyModal">
                <i class="bi bi-key-fill"></i> C√†i ƒë·∫∑t Gemini API
            </button>
            <div id="modelStatus" class="small mt-2 text-warning" style="font-size: 0.8em;"></div>
        </div>
    </div>

    <div class="print-header">
        <h2>B√ÅO C√ÅO S·ª®C KH·ªéE: NGUY·ªÑN ANH TH√ÅI</h2>
        <p>Ng√†y xu·∫•t b√°o c√°o: <script>document.write(new Date().toLocaleDateString('vi-VN'))</script></p>
        <hr>
    </div>

    <div class="container main-content">
        
        <div class="row mb-4 no-print">
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-primary" onclick="window.print()">
                    <span><i class="bi bi-printer-fill"></i> Doctor View</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-success" data-bs-toggle="modal" data-bs-target="#adminModal">
                    <span><i class="bi bi-code-slash"></i> Admin Tool (Full)</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-danger" onclick="generateAIMenu()">
                    <span><i class="bi bi-stars"></i> Th·ª±c ƒë∆°n AI</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-warning" onclick="checkHealthAI()">
                    <span><i class="bi bi-activity"></i> Ph√¢n t√≠ch S√¢u</span>
                </button>
            </div>
        </div>

        <div class="row mb-4 search-section">
            <div class="col-md-12">
                <div class="card p-3 border-primary">
                    <h5 class="text-primary"><i class="bi bi-calculator"></i> AI T√≠nh Calo & Kh·∫©u ph·∫ßn</h5>
                    <div class="input-group">
                        <input type="text" id="aiInput" class="form-control" placeholder="VD: 1 ƒëƒ©a c∆°m t·∫•m s∆∞·ªùn b√¨ ch·∫£, 1 ly tr√† ƒë√°..." onkeypress="handleEnter(event)">
                        <button class="btn btn-primary" onclick="askAI()">T√≠nh ngay</button>
                    </div>
                    <div id="aiLoading" class="text-center mt-2 ai-loading">
                        <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                        <small class="text-muted ms-2">Gemini 2.5 ƒëang t√≠nh to√°n...</small>
                    </div>
                    <div id="aiResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                 <div class="card p-3 h-100">
                    <h5 class="card-title">üî• Calo ti√™u th·ª• h√¥m nay</h5>
                    <div class="d-flex justify-content-between align-items-end">
                        <h2 class="display-4 fw-bold text-danger mb-0" id="dailyCal">0</h2>
                        <div class="text-end">
                            <small class="text-muted">M·ª•c ti√™u</small><br>
                            <h4 class="fw-bold text-secondary" id="targetCal">1800</h4>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 15px;">
                        <div id="calProgress" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary mt-3 w-100" onclick="resetDailyCal()">Reset Calo H√¥m Nay</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 h-100">
                    <h5 class="card-title">‚öñÔ∏è C√¢n n·∫∑ng</h5>
                    <canvas id="weightChart" height="150"></canvas>
                    <div class="text-center mt-2"><small class="text-muted">M·ª•c ti√™u: <span id="targetWeightDisplay">--</span> kg</small></div>
                </div>
            </div>
        </div>

        <div id="menuResult" class="card p-3 mb-4 bg-white border-warning" style="display:none;">
            <h5 class="text-warning"><i class="bi bi-lightbulb"></i> Gemini T∆∞ V·∫•n:</h5>
            <div id="menuContent" class="small"></div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card p-3">
                    <h5 class="card-title">üìä Di·ªÖn bi·∫øn Gout & Gan (K√®m s·ª± ki·ªán)</h5>
                    <canvas id="labChart" height="100"></canvas>
                    <div class="chart-legend">
                        <span class="badge bg-danger">‚ô¶ C·∫•p t√≠nh/Cao</span>
                        <span class="badge bg-success">‚òÖ T·ªët/H·ªìi ph·ª•c</span>
                        <span class="badge bg-warning text-dark">‚óè B√¨nh th∆∞·ªùng</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4 no-print">
            <div class="col-12">
                <div class="card p-3">
                    <h5 class="card-title text-primary" data-bs-toggle="collapse" data-bs-target="#tableCollapse" style="cursor:pointer">
                        <i class="bi bi-table"></i> B·∫£ng Ch·ªâ S·ªë Chi Ti·∫øt (B·∫•m ƒë·ªÉ m·ªü/ƒë√≥ng)
                    </h5>
                    <div class="collapse show" id="tableCollapse">
                        <div class="table-responsive mt-3">
                            <table class="table table-bordered table-hover text-center small" id="compareTable">
                                <thead class="table-light"></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4 water-section h-100 mb-3">
                <h5 class="text-info"><i class="bi bi-droplet-fill"></i> N∆∞·ªõc u·ªëng</h5>
                <h1 class="display-2 fw-bold text-primary" id="waterCount">0</h1>
                <p class="text-muted">ly / M·ª•c ti√™u: <span id="waterTargetDisplay">--</span> L</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary rounded-pill" onclick="addWater()">+ U·ªëng 1 Ly</button>
                    <button class="btn btn-sm btn-link text-muted" onclick="resetWater()">Reset</button>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card p-3 h-100">
                    <h5>üìí Nh·∫≠t k√Ω ƒÉn u·ªëng (Full)</h5>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm small">
                            <thead><tr><th>Ng√†y</th><th>N·ªôi dung</th><th>Calo</th><th>ƒê√°nh gi√°</th></tr></thead>
                            <tbody id="mealTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4 no-print">
            <div class="col-12">
                <div class="card p-3">
                    <h5>‚è∞ L·ªãch tr√¨nh sinh ho·∫°t</h5>
                    <div class="row small text-muted" id="lifestyleTips"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="no-print bg-white py-3 text-center mt-auto border-top">
        <div class="container">
            <small class="text-muted">¬© 2025 Thai Health Ultimate | Powered by Gemini 2.5 Flash</small>
        </div>
    </footer>

    <div class="modal fade" id="keyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">C√†i ƒë·∫∑t Gemini API</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p class="small text-muted">H·ªá th·ªëng s·∫Ω ∆∞u ti√™n d√πng <b>gemini-2.5-flash</b>. N·∫øu l·ªói s·∫Ω t·ª± chuy·ªÉn v·ªÅ <b>gemini-2.0-flash-001</b>.</p>
                    <input type="password" id="apiKeyInput" class="form-control mb-2" placeholder="Paste API Key v√†o ƒë√¢y...">
                    <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="showKey"><label class="form-check-label small" for="showKey">Hi·ªán Key</label></div>
                    <button class="btn btn-primary w-100" onclick="saveKey()">L∆∞u Key</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Admin Tool</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-target="#tabCheckup" data-bs-toggle="tab">Kh√°m</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#tabWeight" data-bs-toggle="tab">C√¢n</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#tabMeal" data-bs-toggle="tab">ƒÇn</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tabCheckup">
                            <input type="date" id="inpDate" class="form-control mb-2">
                            <div class="row g-2">
                                <div class="col-6"><input type="number" id="inpUric" class="form-control" placeholder="Uric"></div>
                                <div class="col-6"><input type="number" id="inpAlt" class="form-control" placeholder="ALT"></div>
                                <div class="col-6"><input type="number" id="inpCre" class="form-control" placeholder="Creatinine"></div>
                                <div class="col-6"><input type="number" id="inpEgfr" class="form-control" placeholder="eGFR"></div>
                                <div class="col-6"><input type="number" id="inpChol" class="form-control" placeholder="Cholesterol"></div>
                                <div class="col-6"><input type="number" id="inpTri" class="form-control" placeholder="Triglyceride"></div>
                                <div class="col-6"><input type="number" id="inpHgb" class="form-control" placeholder="Huy·∫øt s·∫Øc t·ªë"></div>
                                <div class="col-6"><input type="number" id="inpRbc" class="form-control" placeholder="H·ªìng c·∫ßu"></div>
                            </div>
                            <input type="text" id="inpNote" class="form-control mt-2" placeholder="Ghi ch√∫ (VD: Gout c·∫•p, H·ªìi ph·ª•c...)">
                            <button class="btn btn-primary w-100 mt-2" onclick="genCheckupJSON()">T·∫°o JSON</button>
                        </div>
                        <div class="tab-pane fade" id="tabWeight">
                            <input type="date" id="inpWDate" class="form-control mb-2">
                            <input type="number" id="inpWeight" class="form-control mb-2" placeholder="kg">
                            <button class="btn btn-success w-100 mt-2" onclick="genWeightJSON()">T·∫°o JSON</button>
                        </div>
                        <div class="tab-pane fade" id="tabMeal">
                             <input type="date" id="inpMDate" class="form-control mb-2">
                             <textarea id="inpMContent" class="form-control mb-2" rows="2" placeholder="M√≥n ƒÉn..."></textarea>
                             <input type="number" id="inpMCal" class="form-control mb-2" placeholder="Calo (t·ª´ AI)">
                             <textarea id="inpMEval" class="form-control mb-2" rows="2" placeholder="ƒê√°nh gi√° (t·ª´ AI)..."></textarea>
                             <button class="btn btn-warning w-100 mt-2" onclick="genMealJSON()">T·∫°o JSON</button>
                        </div>
                    </div>
                    <textarea id="jsonOutput" class="form-control mt-3 bg-light text-monospace" rows="3" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        let foodDB = [];
        let healthProfile = {};
        const CUP_SIZE = 0.25; 
        let dailyTarget = 2.5; 
        
        // DANH S√ÅCH MODEL ∆ØU TI√äN (D·ª±a tr√™n list b·∫°n cung c·∫•p)
        const MODEL_LIST = [
            "gemini-2.5-flash",         // ∆Øu ti√™n 1: M·ªõi nh·∫•t, ·ªïn ƒë·ªãnh
            "gemini-2.0-flash-001",     // ∆Øu ti√™n 2: C·ª±c k·ª≥ ·ªïn ƒë·ªãnh
            "gemini-2.0-flash-lite-001" // Backup cu·ªëi c√πng
        ];

        // KH·ªûI T·∫†O
        fetch('data.json').then(r => r.json()).then(data => {
            foodDB = data.food_database;
            healthProfile = {
                conditions: data.profile.conditions.join(", "),
                lastCheckup: data.medical_checkups[data.medical_checkups.length - 1],
                targetCal: data.profile.daily_calories_target || 1800
            };
            
            document.getElementById('targetCal').innerText = healthProfile.targetCal;
            document.getElementById('targetWeightDisplay').innerText = data.profile.target_weight;
            
            renderLabChart(data.medical_checkups);
            renderWeightChart(data.weight_log, data.profile.target_weight);
            renderCompareTable(data.medical_checkups);
            renderMeals(data.meal_logs);
            renderLifestyle(data.lifestyle_tips);
            
            calculateTarget(data.medical_checkups[data.medical_checkups.length - 1]);
            loadWater();
            loadDailyCalories();

            const key = localStorage.getItem('geminiKey');
            if(key) document.getElementById('apiKeyInput').value = key;
            else new bootstrap.Modal(document.getElementById('keyModal')).show();
        });

        // --- AI ENGINE: MULTI-MODEL FALLBACK ---
        async function callGemini(prompt) {
            const key = localStorage.getItem('geminiKey');
            if(!key) { alert('Vui l√≤ng nh·∫≠p API Key!'); return null; }

            document.getElementById('aiLoading').style.display = 'block';
            let finalResult = null;
            let errorMsg = "";

            // Th·ª≠ t·ª´ng model trong danh s√°ch
            for (let modelName of MODEL_LIST) {
                try {
                    console.log(`Trying model: ${modelName}...`);
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
                    const response = await fetch(url, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    const data = await response.json();

                    if (data.error) {
                        console.warn(`Model ${modelName} error:`, data.error.message);
                        errorMsg = data.error.message;
                        continue; // Th·ª≠ model ti·∫øp theo
                    }
                    
                    if (data.candidates && data.candidates.length > 0) {
                        finalResult = data.candidates[0].content.parts[0].text;
                        document.getElementById('modelStatus').innerText = `‚úÖ ƒêang d√πng: ${modelName}`;
                        break; // Th√†nh c√¥ng! Tho√°t v√≤ng l·∫∑p
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            document.getElementById('aiLoading').style.display = 'none';

            if (!finalResult) {
                alert(`T·∫•t c·∫£ model ƒë·ªÅu th·∫•t b·∫°i. L·ªói cu·ªëi c√πng: ${errorMsg}`);
                return null;
            }
            return finalResult;
        }

        function saveKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) {
                localStorage.setItem('geminiKey', key);
                bootstrap.Modal.getInstance(document.getElementById('keyModal')).hide();
                alert('ƒê√£ l∆∞u Key! H·ªá th·ªëng s·∫Ω t·ª± ch·ªçn model Gemini 2.5 Flash.');
            }
        }

        // --- T√çNH NƒÇNG 1: AI T√çNH CALO ---
        async function askAI() {
            const query = document.getElementById('aiInput').value;
            if(!query) return;
            const resDiv = document.getElementById('aiResult');
            resDiv.innerHTML = '';

            const prompt = `
                ƒê√≥ng vai chuy√™n gia dinh d∆∞·ª°ng. Ng∆∞·ªùi d√πng h·ªèi: "${query}".
                B·ªánh l√Ω: ${healthProfile.conditions}.
                H√£y ph√¢n t√≠ch m√≥n n√†y.
                Tr·∫£ v·ªÅ ƒê√öNG ƒë·ªãnh d·∫°ng JSON sau (kh√¥ng markdown):
                {
                    "name": "T√™n m√≥n chu·∫©n",
                    "calories": S·ªë_calo_nguy√™n_d∆∞∆°ng,
                    "portion": "Kh·∫©u ph·∫ßn (VD: 1 b√°t, 100g)",
                    "status": "green" (ho·∫∑c "yellow", "red"),
                    "reason": "L√Ω do ng·∫Øn g·ªçn < 15 t·ª´"
                }
            `;

            const aiRes = await callGemini(prompt);
            
            if(aiRes) {
                try {
                    const cleanJson = aiRes.replace(/```json|```/g, '').trim();
                    const data = JSON.parse(cleanJson);
                    
                    let color = data.status === 'green' ? 'success' : (data.status === 'yellow' ? 'warning' : 'danger');
                    let icon = data.status === 'green' ? 'üü¢' : (data.status === 'yellow' ? 'üü°' : 'üî¥');
                    
                    resDiv.innerHTML = `
                        <div class="alert alert-${color} border-${color}">
                            <div class="d-flex justify-content-between">
                                <strong>${icon} ${data.name}</strong>
                                <span class="badge bg-dark fs-6">${data.calories} kcal</span>
                            </div>
                            <p class="mb-2 small">${data.portion} - ${data.reason}</p>
                            <button class="btn btn-sm btn-outline-dark w-100" onclick="addTempCal(${data.calories})">
                                + C·ªông v√†o Calo h√¥m nay
                            </button>
                            <div class="mt-2 text-muted" style="font-size:0.7em">Copy ƒë·ªÉ l∆∞u v√†o Admin Tool:</div>
                            <input type="text" class="form-control form-control-sm" value="${data.name} (${data.calories}kcal). ${data.reason}" readonly>
                        </div>
                    `;
                } catch (e) {
                    resDiv.innerHTML = `<div class="alert alert-secondary small">${aiRes}</div>`;
                }
            }
        }

        // --- CALORIE LOGIC ---
        function loadDailyCalories() {
            const today = new Date().toLocaleDateString('vi-VN');
            if (localStorage.getItem('calDate') !== today) {
                localStorage.setItem('calDate', today);
                localStorage.setItem('dailyCal', 0);
            }
            updateCalUI(parseInt(localStorage.getItem('dailyCal')) || 0);
        }
        function addTempCal(amount) {
            let current = parseInt(localStorage.getItem('dailyCal')) || 0;
            current += amount;
            localStorage.setItem('dailyCal', current);
            updateCalUI(current);
        }
        function resetDailyCal() {
            if(confirm('Reset calo v·ªÅ 0?')) { localStorage.setItem('dailyCal', 0); updateCalUI(0); }
        }
        function updateCalUI(val) {
            document.getElementById('dailyCal').innerText = val;
            const target = healthProfile.targetCal || 1800;
            const pct = Math.min((val / target) * 100, 100);
            const bar = document.getElementById('calProgress');
            bar.style.width = pct + '%';
            bar.className = `progress-bar ${pct > 100 ? 'bg-danger' : (pct > 80 ? 'bg-warning' : 'bg-success')}`;
        }

        // --- AI MENU & ANALYSIS ---
        async function generateAIMenu() {
            const prompt = `G·ª£i √Ω th·ª±c ƒë∆°n 1 ng√†y cho ng∆∞·ªùi b·ªã: ${healthProfile.conditions}. T·ªïng calo: ${healthProfile.targetCal}. M√≥n Vi·ªát, d·ªÖ n·∫•u. Ghi r√µ calo t·ª´ng m√≥n. Markdown.`;
            const res = await callGemini(prompt);
            if(res) { document.getElementById('menuResult').style.display='block'; document.getElementById('menuContent').innerHTML = marked.parse(res); }
        }
        async function checkHealthAI() {
            const prompt = `Ph√¢n t√≠ch s√¢u b·ªô ch·ªâ s·ªë n√†y: ${JSON.stringify(healthProfile.lastCheckup)}. Xu h∆∞·ªõng t·ªët hay x·∫•u? C·∫ßn l√†m g√¨ ngay? Markdown.`;
            const res = await callGemini(prompt);
            if(res) { document.getElementById('menuResult').style.display='block'; document.getElementById('menuContent').innerHTML = marked.parse(res); }
        }

        // --- CHART (KH√îI PH·ª§C LOGIC S·ª∞ KI·ªÜN) ---
        function renderLabChart(logs) {
            const ctx = document.getElementById('labChart').getContext('2d');
            // Logic s·ª± ki·ªán: T√¨m keyword trong note
            const pColors = logs.map(l => {
                const n = (l.note || '').toLowerCase();
                if(n.includes('c·∫•p') || n.includes('cao')) return '#e74c3c'; // ƒê·ªè
                if(n.includes('t·ªët') || n.includes('h·ªìi ph·ª•c') || n.includes('gi·∫£m')) return '#27ae60'; // Xanh
                return '#f1c40f'; // V√†ng
            });
            const pStyles = logs.map(l => {
                const n = (l.note || '').toLowerCase();
                if(n.includes('t·ªët') || n.includes('h·ªìi ph·ª•c')) return 'star';
                if(n.includes('c·∫•p') || n.includes('cao')) return 'rectRot'; // H√¨nh thoi
                return 'circle';
            });
            const pSizes = logs.map(l => (l.note && l.note.length > 5) ? 8 : 4);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [
                        { label: 'Gout', data: logs.map(l => l.uric_acid), borderColor: '#e74c3c', pointBackgroundColor: pColors, pointStyle: pStyles, pointRadius: pSizes, yAxisID: 'y' },
                        { label: 'Men gan', data: logs.map(l => l.alt_liver), borderColor: '#f1c40f', pointRadius: 0, yAxisID: 'y1' },
                        { label: 'Ng∆∞·ª°ng Gout', data: Array(logs.length).fill(420), borderColor: 'rgba(231,76,60,0.2)', borderDash:[5,5], pointRadius:0, yAxisID:'y' }
                    ]
                },
                options: { 
                    responsive: true, 
                    plugins: { tooltip: { callbacks: { footer: (items) => { const n = logs[items[0].dataIndex].note; return n ? 'üìå ' + n : ''; } } } },
                    scales: { y: {position:'left', title:{display:true,text:'Uric'}}, y1: {position:'right', grid:{drawOnChartArea:false}} } 
                }
            });
        }

        // --- OTHER RENDER FUNCTIONS ---
        function renderWeightChart(logs, target) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [{ label: 'Kg', data: logs.map(l => l.value), borderColor: '#3498db', tension: 0.3, fill:true, backgroundColor: 'rgba(52,152,219,0.1)' }, { label: 'M·ª•c ti√™u', data: Array(logs.length).fill(target), borderColor: '#27ae60', borderDash:[5,5], pointRadius:0 }]
                }
            });
        }
        function renderCompareTable(logs) {
            const thead = document.querySelector('#compareTable thead');
            const tbody = document.querySelector('#compareTable tbody');
            let hHTML = `<tr><th class="text-start">Ch·ªâ s·ªë</th>`;
            logs.forEach(l => hHTML += `<th>${l.date}</th>`);
            thead.innerHTML = hHTML + '</tr>';
            
            const metrics = [
                {n:'Acid Uric', k:'uric_acid', u:'¬µmol/L', max:420},
                {n:'ALT (Gan)', k:'alt_liver', u:'U/L', max:40},
                {n:'eGFR (Th·∫≠n)', k:'egfr', u:'ml/min', min:90},
                {n:'H·ªìng c·∫ßu', k:'rbc', u:'M/¬µL', max:5.2},
                {n:'Huy·∫øt s·∫Øc t·ªë', k:'hgb', u:'g/dL', max:16.5}
            ];
            
            tbody.innerHTML = '';
            metrics.forEach(m => {
                let row = `<tr><td class="text-start fw-bold">${m.n} <small>(${m.u})</small></td>`;
                logs.forEach(l => {
                    let v = l[m.k] || '-';
                    let cls = '';
                    if(typeof v === 'number') {
                        if(m.max && v > m.max) cls = 'text-danger fw-bold';
                        if(m.min && v < m.min) cls = 'text-danger fw-bold';
                    }
                    row += `<td class="${cls}">${v}</td>`;
                });
                tbody.innerHTML += row + '</tr>';
            });
        }
        function renderMeals(logs) {
             const tbody = document.getElementById('mealTable'); tbody.innerHTML = '';
             logs.slice().reverse().slice(0,10).forEach(log => {
                let calBadge = log.calories ? `<span class="badge bg-secondary">${log.calories} kcal</span>` : '';
                tbody.innerHTML += `<tr><td>${log.date}</td><td>${log.content}</td><td>${calBadge}</td><td><em class="text-success small">${log.evaluation}</em></td></tr>`;
            });
        }
        function renderLifestyle(tips) {
            document.getElementById('lifestyleTips').innerHTML = `<div class="col-6 col-md-3 mb-2">üåÖ <b>S√°ng:</b><br>${tips.morning}</div><div class="col-6 col-md-3 mb-2">üç± <b>ƒÇn:</b><br>${tips.eating}</div><div class="col-6 col-md-3 mb-2">üåô <b>T·ªëi:</b><br>${tips.evening}</div><div class="col-6 col-md-3 mb-2">üèÉ <b>T·∫≠p:</b><br>${tips.exercise}</div>`;
        }

        // --- HELPERS & ADMIN ---
        function handleEnter(e) { if(e.key === 'Enter') askAI(); }
        function calculateTarget(latest) { if(latest.uric_acid > 400 || latest.alt_liver > 40) dailyTarget = 3.0; else dailyTarget = 2.5; document.getElementById('waterTargetDisplay').innerText = dailyTarget; }
        function loadWater() {
            const t = new Date().toLocaleDateString('vi-VN');
            if(localStorage.getItem('waterDate') !== t) { localStorage.setItem('waterDate', t); localStorage.setItem('waterCount', 0); }
            document.getElementById('waterCount').innerText = localStorage.getItem('waterCount') || 0;
        }
        function addWater() {
            let c = (parseInt(localStorage.getItem('waterCount'))||0) + 1;
            localStorage.setItem('waterCount', c); document.getElementById('waterCount').innerText = c;
        }
        function resetWater() { if(confirm('Reset?')) { localStorage.setItem('waterCount', 0); document.getElementById('waterCount').innerText=0; } }
        
        function genCheckupJSON() {
            const obj = {
                date: document.getElementById('inpDate').value,
                uric_acid: parseFloat(document.getElementById('inpUric').value),
                alt_liver: parseFloat(document.getElementById('inpAlt').value),
                creatinine: parseFloat(document.getElementById('inpCre').value)||null,
                egfr: parseFloat(document.getElementById('inpEgfr').value)||null,
                cholesterol: parseFloat(document.getElementById('inpChol').value)||null,
                triglyceride: parseFloat(document.getElementById('inpTri').value)||null,
                hgb: parseFloat(document.getElementById('inpHgb').value)||null,
                rbc: parseFloat(document.getElementById('inpRbc').value)||null,
                note: document.getElementById('inpNote').value
            };
            showJSON(obj);
        }
        function genWeightJSON() { showJSON({ date: document.getElementById('inpWDate').value, value: parseFloat(document.getElementById('inpWeight').value) }); }
        function genMealJSON() { 
            showJSON({ 
                date: document.getElementById('inpMDate').value, 
                content: document.getElementById('inpMContent').value, 
                calories: parseFloat(document.getElementById('inpMCal').value)||null,
                evaluation: document.getElementById('inpMEval').value 
            }); 
        }
        function showJSON(obj) { const out = document.getElementById('jsonOutput'); out.value = JSON.stringify(obj, null, 2) + ","; out.select(); document.execCommand('copy'); alert('ƒê√£ Copy!'); }
        document.getElementById('showKey').addEventListener('change', function() { document.getElementById('apiKeyInput').type = this.checked ? 'text' : 'password'; });
    </script>
</body>
</html>