<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Health Super-App</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2980b9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        .main-content { flex: 1; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .header-gradient { background: linear-gradient(135deg, #2980b9, #2c3e50); color: white; padding: 40px 0 30px; border-radius: 0 0 30px 30px; margin-bottom: 30px; }
        .tool-btn { border-radius: 12px; padding: 15px; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: none; width: 100%; margin-bottom: 10px; text-align: left; display: flex; align-items: center; justify-content: space-between; }
        .tool-btn i { font-size: 1.5rem; }
        footer { background: #fff; padding: 20px 0; margin-top: auto; text-align: center; border-top: 1px solid #eee; }
        
        /* Print Styles (Doctor View) */
        @media print {
            body { background: white; }
            .no-print, .header-gradient, footer, .tool-btn, .search-section, .water-section { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; }
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
            .container { max-width: 100%; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>

    <div class="header-gradient text-center no-print">
        <div class="container">
            <h1 class="fw-bold">Nguy·ªÖn Anh Th√°i</h1>
            <p class="mb-0 opacity-75">Health Dashboard & Analytics</p>
            <div class="mt-3">
                <span class="badge bg-light text-dark mx-1">Gout</span>
                <span class="badge bg-light text-dark mx-1">GERD</span>
                <span class="badge bg-light text-dark mx-1">Men Gan</span>
                <span class="badge bg-light text-dark mx-1">Th·∫≠n (eGFR)</span>
            </div>
        </div>
    </div>

    <div class="print-header">
        <h2>B√ÅO C√ÅO S·ª®C KH·ªéE: NGUY·ªÑN ANH TH√ÅI</h2>
        <p>Ng√†y xu·∫•t b√°o c√°o: <script>document.write(new Date().toLocaleDateString('vi-VN'))</script></p>
        <hr>
    </div>

    <div class="container main-content">
        
        <div class="row mb-4 no-print">
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-primary" onclick="window.print()">
                    <span><i class="bi bi-printer-fill"></i> Doctor View</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-success" data-bs-toggle="modal" data-bs-target="#adminModal">
                    <span><i class="bi bi-code-slash"></i> T·∫°o JSON</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-danger" data-bs-toggle="modal" data-bs-target="#analyticsModal">
                    <span><i class="bi bi-graph-up-arrow"></i> Ph√¢n t√≠ch s√¢u</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-warning" onclick="generateMenu()">
                    <span><i class="bi bi-dice-5-fill"></i> H√¥m nay ƒÉn g√¨?</span>
                </button>
            </div>
        </div>

        <div class="row mb-4 search-section">
            <div class="col-md-12">
                <div class="card p-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="foodSearch" class="form-control border-0" placeholder="Tra c·ª©u th·ª±c ph·∫©m (B√≤, G√†, Bia...)" onkeyup="searchFood()">
                    </div>
                    <div id="searchResult" class="mt-2 px-2"></div>
                </div>
            </div>
        </div>

        <div id="menuResult" class="alert alert-success no-print" style="display:none;"></div>

        <div class="row mb-4">
            <div class="col-md-7">
                <div class="card p-3 h-100">
                    <h5 class="card-title">üìä Ch·ªâ s·ªë m√°u (K√®m ng∆∞·ª°ng an to√†n)</h5>
                    <canvas id="labChart"></canvas>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-3 h-100">
                    <h5 class="card-title">‚öñÔ∏è C√¢n n·∫∑ng & M·ª•c ti√™u</h5>
                    <canvas id="weightChart"></canvas>
                    <div class="text-center mt-2 no-print">
                        <small class="text-muted">M·ª•c ti√™u: <span id="targetWeightDisplay">--</span> kg</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4 water-section">
                <div class="card p-3 h-100 text-center bg-white">
                    <h5 class="text-info">üíß N∆∞·ªõc u·ªëng</h5>
                    <h2 class="fw-bold text-primary my-3"><span id="waterCount">0</span> <small class="fs-6 text-muted">ly</small></h2>
                    <div class="progress mb-3" style="height: 8px;">
                        <div id="waterProgress" class="progress-bar bg-info" style="width: 0%"></div>
                    </div>
                    <button class="btn btn-outline-primary w-100 rounded-pill" onclick="addWater()">+ 1 Ly (250ml)</button>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card p-3 h-100">
                    <h5>üìí Nh·∫≠t k√Ω & ƒê√°nh gi√° AI</h5>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead><tr><th>Ng√†y</th><th>N·ªôi dung</th><th>AI ƒê√°nh gi√°</th></tr></thead>
                            <tbody id="mealTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4 no-print">
             <div class="col-12">
                <div class="card p-3">
                    <h5>‚è∞ L·ªãch tr√¨nh sinh ho·∫°t</h5>
                    <div class="row small text-muted" id="lifestyleTips"></div>
                </div>
             </div>
        </div>
    </div>

    <footer class="no-print">
        <div class="container">
            <small>¬© 2025 Personal Health Tracker | Dev by Thai & Gemini AI</small>
        </div>
    </footer>

    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Tool: T·∫°o JSON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-target="#tabCheckup" data-bs-toggle="tab">Kh√°m b·ªánh</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#tabWeight" data-bs-toggle="tab">C√¢n n·∫∑ng</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#tabMeal" data-bs-toggle="tab">Nh·∫≠t k√Ω ƒÉn</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tabCheckup">
                            <div class="mb-2"><label>Ng√†y:</label><input type="date" id="inpDate" class="form-control"></div>
                            <div class="row">
                                <div class="col-6 mb-2"><label>Acid Uric:</label><input type="number" id="inpUric" class="form-control" placeholder="¬µmol/L"></div>
                                <div class="col-6 mb-2"><label>Men gan (ALT):</label><input type="number" id="inpAlt" class="form-control" placeholder="U/L"></div>
                                <div class="col-6 mb-2"><label>Creatinine:</label><input type="number" id="inpCre" class="form-control" placeholder="¬µmol/L"></div>
                                <div class="col-6 mb-2"><label>eGFR:</label><input type="number" id="inpEgfr" class="form-control" placeholder="ml/min"></div>
                            </div>
                            <div class="mb-2"><label>Ghi ch√∫:</label><input type="text" id="inpNote" class="form-control"></div>
                            <button class="btn btn-primary w-100 mt-2" onclick="genCheckupJSON()">T·∫°o Code JSON</button>
                        </div>
                        <div class="tab-pane fade" id="tabWeight">
                            <div class="mb-2"><label>Ng√†y:</label><input type="date" id="inpWDate" class="form-control"></div>
                            <div class="mb-2"><label>C√¢n n·∫∑ng (kg):</label><input type="number" id="inpWeight" class="form-control"></div>
                            <button class="btn btn-success w-100 mt-2" onclick="genWeightJSON()">T·∫°o Code JSON</button>
                        </div>
                        <div class="tab-pane fade" id="tabMeal">
                             <div class="mb-2"><label>Ng√†y:</label><input type="date" id="inpMDate" class="form-control"></div>
                             <div class="mb-2"><label>N·ªôi dung:</label><textarea id="inpMContent" class="form-control" rows="2"></textarea></div>
                             <div class="mb-2"><label>AI ƒê√°nh gi√°:</label><textarea id="inpMEval" class="form-control" rows="2"></textarea></div>
                             <button class="btn btn-warning w-100 mt-2" onclick="genMealJSON()">T·∫°o Code JSON</button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label>K·∫øt qu·∫£ (Copy v√† d√°n v√†o data.json):</label>
                        <textarea id="jsonOutput" class="form-control bg-light text-monospace" rows="4" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="analyticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ph√¢n t√≠ch t∆∞∆°ng quan: C√¢n n·∫∑ng vs Gan/Gout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Bi·ªÉu ƒë·ªì n√†y gi√∫p b·∫°n tr·∫£ l·ªùi c√¢u h·ªèi: "Gi·∫£m c√¢n c√≥ gi√∫p gi·∫£m men gan v√† acid uric kh√¥ng?"</p>
                    <canvas id="corrChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let foodDB = [];
        let fullData = {};
        const CUP_SIZE = 0.25; let dailyTarget = 2.5; 

        // KH·ªûI T·∫†O
        fetch('data.json').then(r => r.json()).then(data => {
            fullData = data;
            foodDB = data.food_database;
            
            // Render UI
            renderLabChart(data.medical_checkups);
            renderWeightChart(data.weight_log, data.profile.target_weight);
            renderMeals(data.meal_logs);
            renderLifestyle(data.lifestyle_tips);
            document.getElementById('targetWeightDisplay').innerText = data.profile.target_weight;

            // Logic n∆∞·ªõc u·ªëng
            calculateTarget(data.medical_checkups[data.medical_checkups.length - 1]);
            loadWater();

            // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì ph√¢n t√≠ch
            initCorrelationChart(data);
        });

        // --- 1. LOGIC C∆† B·∫¢N (Chart, Water, Search) ---
        function renderLabChart(logs) {
            const ctx = document.getElementById('labChart').getContext('2d');
            const labels = logs.map(l => l.date);
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Gout', data: logs.map(l => l.uric_acid), borderColor: '#e74c3c', tension: 0.3, yAxisID: 'y' },
                        { label: 'Men gan', data: logs.map(l => l.alt_liver), borderColor: '#f1c40f', tension: 0.3, yAxisID: 'y1' },
                        { label: 'Th·∫≠n (eGFR)', data: logs.map(l => l.egfr), borderColor: '#2ecc71', borderDash:[5,5], tension: 0.3, yAxisID: 'y1', hidden: false },
                        // Ng∆∞·ª°ng
                        { label: 'Safe Gout', data: Array(logs.length).fill(420), borderColor: 'rgba(231,76,60,0.2)', borderDash:[10,5], pointRadius:0, yAxisID:'y' }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: {display:true, text:'Uric (¬µmol/L)'} },
                        y1: { type: 'linear', display: true, position: 'right', grid:{drawOnChartArea:false} }
                    }
                }
            });
        }

        function renderWeightChart(logs, target) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [
                        { label: 'Kg', data: logs.map(l => l.value), borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', fill: true, tension: 0.3 },
                        { label: 'M·ª•c ti√™u', data: Array(logs.length).fill(target), borderColor: '#27ae60', borderDash:[5,5], pointRadius:0 }
                    ]
                }
            });
        }

        function searchFood() {
            const input = document.getElementById('foodSearch').value.toLowerCase();
            const res = document.getElementById('searchResult');
            res.innerHTML = '';
            if(input.length < 2) return;
            const found = foodDB.filter(i => i.name.toLowerCase().includes(input));
            if(found.length){
                found.forEach(i => {
                    let color = i.status === 'green' ? 'success' : (i.status === 'yellow' ? 'warning' : 'danger');
                    let icon = i.status === 'green' ? 'üü¢' : (i.status === 'yellow' ? 'üü°' : 'üî¥');
                    res.innerHTML += `<div class="alert alert-${color} py-2 mb-2 small"><strong>${icon} ${i.name}</strong>: ${i.reason}</div>`;
                });
            } else res.innerHTML = '<div class="text-muted small p-2">Kh√¥ng t√¨m th·∫•y.</div>';
        }

        // --- 2. LOGIC N√ÇNG CAO (Correlation Chart) ---
        function initCorrelationChart(data) {
            // Gh√©p d·ªØ li·ªáu: T√¨m ng√†y n√†o c√≥ c·∫£ C√¢n n·∫∑ng v√† X√©t nghi·ªám (g·∫ßn ƒë√∫ng)
            // ƒê·ªÉ ƒë∆°n gi·∫£n, l·∫•y danh s√°ch x√©t nghi·ªám l√†m chu·∫©n, t√¨m c√¢n n·∫∑ng g·∫ßn ng√†y ƒë√≥ nh·∫•t
            const labels = data.medical_checkups.map(m => m.date);
            const altData = data.medical_checkups.map(m => m.alt_liver);
            const weightData = data.medical_checkups.map(m => {
                // T√¨m c√¢n n·∫∑ng g·∫ßn ng√†y x√©t nghi·ªám nh·∫•t
                const mDate = new Date(m.date);
                let closestW = null;
                let minDiff = Infinity;
                data.weight_log.forEach(w => {
                    const wDate = new Date(w.date);
                    const diff = Math.abs(mDate - wDate);
                    if(diff < minDiff) { minDiff = diff; closestW = w.value; }
                });
                return closestW;
            });

            const ctx = document.getElementById('corrChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'C√¢n n·∫∑ng (Tr·ª•c tr√°i)', data: weightData, borderColor: '#3498db', yAxisID: 'y', tension: 0.3 },
                        { label: 'Men gan ALT (Tr·ª•c ph·∫£i)', data: altData, borderColor: '#f1c40f', yAxisID: 'y1', tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { position: 'left', title: {display:true, text:'Kg'} },
                        y1: { position: 'right', title: {display:true, text:'U/L'}, grid:{drawOnChartArea:false} }
                    }
                }
            });
        }

        // --- 3. LOGIC ADMIN TOOL (JSON Generator) ---
        function genCheckupJSON() {
            const obj = {
                date: document.getElementById('inpDate').value,
                uric_acid: parseFloat(document.getElementById('inpUric').value),
                alt_liver: parseFloat(document.getElementById('inpAlt').value),
                creatinine: parseFloat(document.getElementById('inpCre').value) || null,
                egfr: parseFloat(document.getElementById('inpEgfr').value) || null,
                note: document.getElementById('inpNote').value
            };
            showJSON(JSON.stringify(obj, null, 2) + ",");
        }
        function genWeightJSON() {
            const obj = { date: document.getElementById('inpWDate').value, value: parseFloat(document.getElementById('inpWeight').value) };
            showJSON(JSON.stringify(obj, null, 2) + ",");
        }
        function genMealJSON() {
            const obj = {
                date: document.getElementById('inpMDate').value,
                content: document.getElementById('inpMContent').value,
                evaluation: document.getElementById('inpMEval').value
            };
            showJSON(JSON.stringify(obj, null, 2) + ",");
        }
        function showJSON(str) {
            const out = document.getElementById('jsonOutput');
            out.value = str;
            out.select();
            document.execCommand('copy');
            alert('ƒê√£ t·∫°o v√† COPY code! H√£y paste v√†o data.json');
        }

        // --- 4. LOGIC MENU GENERATOR ---
        function generateMenu() {
            const greens = foodDB.filter(f => f.status === 'green');
            if(greens.length < 3) { alert('Ch∆∞a ƒë·ªß d·ªØ li·ªáu m√≥n xanh!'); return; }
            
            // Random 3 m√≥n
            const shuffled = greens.sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 3);
            
            const html = `<strong>üí° G·ª£i √Ω th·ª±c ƒë∆°n an to√†n h√¥m nay:</strong><br>
                - M√≥n 1: ${selected[0].name} (${selected[0].reason})<br>
                - M√≥n 2: ${selected[1].name}<br>
                - M√≥n 3: ${selected[2].name}`;
            
            const div = document.getElementById('menuResult');
            div.innerHTML = html;
            div.style.display = 'block';
        }

        // --- 5. C√ÅC H√ÄM UI PH·ª§ ---
        function renderLifestyle(tips) {
            document.getElementById('lifestyleTips').innerHTML = `
                <div class="col-6 col-md-3">üåÖ S√°ng: ${tips.morning}</div>
                <div class="col-6 col-md-3">üç± ƒÇn: ${tips.eating}</div>
                <div class="col-6 col-md-3">üåô T·ªëi: ${tips.evening}</div>
                <div class="col-6 col-md-3">üèÉ T·∫≠p: ${tips.exercise}</div>
            `;
        }
        function renderMeals(logs) {
             const tbody = document.getElementById('mealTable');
             tbody.innerHTML = '';
             logs.slice().reverse().slice(0,10).forEach(log => {
                tbody.innerHTML += `<tr><td>${log.date}</td><td>${log.content}</td><td><em class="text-success small">${log.evaluation}</em></td></tr>`;
            });
        }
        function calculateTarget(latest) {
            if(latest.uric_acid > 400 || latest.alt_liver > 40) dailyTarget = 3.0; else dailyTarget = 2.5;
        }
        function loadWater() {
            const today = new Date().toLocaleDateString('vi-VN');
            const savedDate = localStorage.getItem('waterDate');
            let count = (savedDate === today) ? parseInt(localStorage.getItem('waterCount')) || 0 : 0;
            if(savedDate !== today) { localStorage.setItem('waterDate', today); localStorage.setItem('waterCount', 0); }
            updateWaterUI(count);
        }
        function addWater() {
            let count = parseInt(localStorage.getItem('waterCount')) || 0;
            count++;
            localStorage.setItem('waterCount', count);
            localStorage.setItem('waterDate', new Date().toLocaleDateString('vi-VN'));
            updateWaterUI(count);
        }
        function updateWaterUI(count) {
            document.getElementById('waterCount').innerText = count;
            const percent = Math.min((count * CUP_SIZE / dailyTarget) * 100, 100);
            const bar = document.getElementById('waterProgress');
            bar.style.width = percent + '%';
        }
    </script>
</body>
</html>