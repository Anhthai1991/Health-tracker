<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai Health AI Assistant</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        .main-content { flex: 1; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header-gradient { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 40px 0 30px; border-radius: 0 0 30px 30px; margin-bottom: 30px; }
        .tool-btn { border-radius: 12px; padding: 15px; font-weight: 600; border: none; width: 100%; margin-bottom: 10px; text-align: left; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-loading { display: none; }
        .ai-badge { background: linear-gradient(45deg, #8e44ad, #3498db); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="header-gradient text-center">
        <div class="container">
            <h1 class="fw-bold">Nguy·ªÖn Anh Th√°i <span class="ai-badge">AI Powered</span></h1>
            <p class="opacity-75">Tr·ª£ l√Ω s·ª©c kh·ªèe c√° nh√¢n</p>
            <button class="btn btn-sm btn-outline-light mt-2 rounded-pill" data-bs-toggle="modal" data-bs-target="#keyModal">
                <i class="bi bi-key-fill"></i> C√†i ƒë·∫∑t Gemini API Key
            </button>
            <div id="modelStatus" class="small mt-2 text-warning" style="font-size: 0.8em;"></div>
        </div>
    </div>

    <div class="container main-content">
        
        <div class="row mb-4">
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-primary" onclick="window.print()">
                    <span><i class="bi bi-printer"></i> B√°o c√°o</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-success" data-bs-toggle="modal" data-bs-target="#adminModal">
                    <span><i class="bi bi-code-slash"></i> T·∫°o JSON</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-danger" onclick="generateAIMenu()">
                    <span><i class="bi bi-stars"></i> AI G·ª£i √Ω m√≥n</span>
                </button>
            </div>
            <div class="col-6 col-md-3">
                <button class="tool-btn bg-white text-warning" onclick="checkHealthAI()">
                    <span><i class="bi bi-activity"></i> AI Ph√¢n t√≠ch</span>
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card p-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="foodSearch" class="form-control border-0" placeholder="H·ªèi AI v·ªÅ th·ª±c ph·∫©m (VD: B√∫n ri√™u, Tr√† s·ªØa...)" onkeypress="handleEnter(event)">
                        <button class="btn btn-primary rounded-pill px-4" onclick="searchWithAI()">H·ªèi Gemini</button>
                    </div>
                    <div id="aiLoading" class="text-center mt-3 ai-loading">
                        <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                        <small class="text-muted ms-2">Gemini ƒëang suy nghƒ©...</small>
                    </div>
                    <div id="searchResult" class="mt-3 px-2"></div>
                </div>
            </div>
        </div>

        <div id="menuResult" class="card p-3 mb-4 bg-white border-primary" style="display:none; border-left: 5px solid #0d6efd;">
            <h5 class="text-primary"><i class="bi bi-robot"></i> Gemini t∆∞ v·∫•n:</h5>
            <div id="menuContent" class="small"></div>
        </div>

        <div class="row mb-4">
            <div class="col-md-7">
                <div class="card p-3 h-100">
                    <h5>Ch·ªâ s·ªë m√°u</h5>
                    <canvas id="labChart"></canvas>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card p-3 h-100">
                    <h5>C√¢n n·∫∑ng</h5>
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="keyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">C√†i ƒë·∫∑t Gemini API</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Nh·∫≠p API Key. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông d√≤ t√¨m phi√™n b·∫£n AI ph√π h·ª£p nh·∫•t v·ªõi Key c·ªßa b·∫°n.</p>
                    <input type="password" id="apiKeyInput" class="form-control mb-2" placeholder="Paste API Key v√†o ƒë√¢y...">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="showKey">
                        <label class="form-check-label small" for="showKey">Hi·ªán Key</label>
                    </div>
                    <button class="btn btn-primary w-100" onclick="saveKeyAndDetect()">L∆∞u & D√≤ t√¨m Model</button>
                    <hr>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="small">üëâ L·∫•y API Key mi·ªÖn ph√≠ t·∫°i ƒë√¢y</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Tool: T·∫°o JSON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Nh·∫≠p d·ªØ li·ªáu, sau ƒë√≥ copy m√£ JSON d√°n v√†o file data.json</p>
                    <div class="mb-2"><label>Ng√†y:</label><input type="date" id="inpDate" class="form-control"></div>
                    <div class="row">
                        <div class="col-6 mb-2"><label>Acid Uric:</label><input type="number" id="inpUric" class="form-control" placeholder="¬µmol/L"></div>
                        <div class="col-6 mb-2"><label>Men gan (ALT):</label><input type="number" id="inpAlt" class="form-control" placeholder="U/L"></div>
                        <div class="col-6 mb-2"><label>Creatinine:</label><input type="number" id="inpCre" class="form-control" placeholder="¬µmol/L"></div>
                        <div class="col-6 mb-2"><label>eGFR:</label><input type="number" id="inpEgfr" class="form-control" placeholder="ml/min"></div>
                    </div>
                    <div class="mb-2"><label>Ghi ch√∫:</label><input type="text" id="inpNote" class="form-control" placeholder="VD: H·ªìi ph·ª•c t·ªët..."></div>
                    <button class="btn btn-primary w-100 mt-2" onclick="genCheckupJSON()">T·∫°o Code JSON</button>
                    <textarea id="jsonOutput" class="form-control mt-3 bg-light text-monospace" rows="4" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        let foodDB = [];
        let healthProfile = {}; 
        
        // KH·ªûI T·∫†O
        fetch('data.json').then(r => r.json()).then(data => {
            foodDB = data.food_database;
            healthProfile = {
                conditions: data.profile.conditions.join(", "),
                lastCheckup: data.medical_checkups[data.medical_checkups.length - 1]
            };
            
            renderLabChart(data.medical_checkups);
            renderWeightChart(data.weight_log, data.profile.target_weight);
            
            // Ki·ªÉm tra Key & Model ƒë√£ l∆∞u ch∆∞a
            const key = localStorage.getItem('geminiKey');
            const savedModel = localStorage.getItem('geminiModel');
            if(key) {
                document.getElementById('apiKeyInput').value = key;
                if(savedModel) {
                    document.getElementById('modelStatus').innerText = `‚úÖ ƒêang d√πng: ${savedModel}`;
                } else {
                    // C√≥ key nh∆∞ng ch∆∞a bi·∫øt model, t·ª± d√≤
                    detectModel(key);
                }
            } else {
                // Ch∆∞a c√≥ key, m·ªü modal
                 const modal = new bootstrap.Modal(document.getElementById('keyModal'));
                 modal.show();
            }
        });

        // --- H√ÄM QUAN TR·ªåNG NH·∫§T: T·ª∞ D√í T√åM MODEL ---
        async function detectModel(key) {
            const statusDiv = document.getElementById('modelStatus');
            statusDiv.innerText = "‚è≥ ƒêang d√≤ t√¨m phi√™n b·∫£n AI ph√π h·ª£p...";
            
            try {
                // G·ªçi API l·∫•y danh s√°ch Model
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await response.json();

                if(data.error) {
                    alert('L·ªói Key: ' + data.error.message);
                    statusDiv.innerText = "‚ùå Key kh√¥ng h·ª£p l·ªá";
                    return;
                }

                // T√¨m model h·ªó tr·ª£ 'generateContent'
                const validModel = data.models.find(m => 
                    m.supportedGenerationMethods.includes("generateContent") && 
                    (m.name.includes("flash") || m.name.includes("pro"))
                );

                if (validModel) {
                    // Google tr·∫£ v·ªÅ d·∫°ng "models/gemini-1.5-flash", ta c·∫ßn c·∫Øt b·ªè "models/"
                    const modelName = validModel.name.replace("models/", "");
                    localStorage.setItem('geminiModel', modelName);
                    statusDiv.innerText = `‚úÖ ƒê√£ k·∫øt n·ªëi: ${modelName}`;
                    alert(`Th√†nh c√¥ng! H·ªá th·ªëng ƒë√£ ch·ªçn model: ${modelName}`);
                } else {
                    // Fallback n·∫øu kh√¥ng t√¨m th·∫•y c√°i n√†o quen thu·ªôc
                    localStorage.setItem('geminiModel', 'gemini-1.5-flash');
                    statusDiv.innerText = "‚ö†Ô∏è D√πng m·∫∑c ƒë·ªãnh: gemini-1.5-flash";
                }

            } catch (e) {
                console.error(e);
                statusDiv.innerText = "‚ùå L·ªói k·∫øt n·ªëi m·∫°ng";
            }
        }

        function saveKeyAndDetect() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) {
                localStorage.setItem('geminiKey', key);
                // X√≥a model c≈© ƒë·ªÉ d√≤ l·∫°i
                localStorage.removeItem('geminiModel');
                bootstrap.Modal.getInstance(document.getElementById('keyModal')).hide();
                detectModel(key);
            }
        }

        // --- H√ÄM G·ªåI AI (ƒê√£ d√πng model t·ª± d√≤) ---
        async function callGemini(prompt) {
            const key = localStorage.getItem('geminiKey');
            let modelName = localStorage.getItem('geminiModel');
            
            if(!key) {
                alert('Ch∆∞a c√≥ API Key!'); 
                return null;
            }
            // N·∫øu ch∆∞a c√≥ model, d√πng m·∫∑c ƒë·ªãnh an to√†n nh·∫•t
            if(!modelName) modelName = 'gemini-1.5-flash';

            document.getElementById('aiLoading').style.display = 'block';
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                document.getElementById('aiLoading').style.display = 'none';

                if (data.error) {
                    // N·∫øu l·ªói Model not found, th·ª≠ d√≤ l·∫°i ngay l·∫≠p t·ª©c
                    if(data.error.message.includes('not found')) {
                        alert('Model c≈© b·ªã l·ªói, ƒëang t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·∫°i...');
                        await detectModel(key);
                        return null; // B·∫Øt ng∆∞·ªùi d√πng b·∫•m l·∫°i l·∫ßn n·ªØa cho ch·∫Øc
                    }
                    alert('L·ªói Google: ' + data.error.message);
                    return null;
                }

                if (!data.candidates || data.candidates.length === 0) return "AI kh√¥ng ph·∫£n h·ªìi.";
                return data.candidates[0].content.parts[0].text;

            } catch (error) {
                document.getElementById('aiLoading').style.display = 'none';
                alert('L·ªói m·∫°ng: ' + error.message);
                return null;
            }
        }

        // --- C√ÅC H√ÄM LOGIC C≈® (Search, Menu, Charts...) ---
        async function searchWithAI() {
            const query = document.getElementById('foodSearch').value;
            if(!query) return;
            const localResult = foodDB.find(f => f.name.toLowerCase().includes(query.toLowerCase()));
            const resDiv = document.getElementById('searchResult');
            
            if(localResult) {
                let color = localResult.status === 'green' ? 'success' : (localResult.status === 'yellow' ? 'warning' : 'danger');
                resDiv.innerHTML = `<div class="alert alert-${color}"><strong>(Database) ${localResult.name}</strong>: ${localResult.reason}</div>`;
                return;
            }

            const prompt = `T√¥i b·ªã b·ªánh: ${healthProfile.conditions}. Acid Uric ${healthProfile.lastCheckup.uric_acid}, Men gan ${healthProfile.lastCheckup.alt_liver}. ƒê√°nh gi√° m√≥n "${query}". Tr·∫£ v·ªÅ JSON duy nh·∫•t: {"status": "green/yellow/red", "reason": "ng·∫Øn g·ªçn", "name": "${query}"}`;

            const aiRes = await callGemini(prompt);
            if(aiRes) {
                try {
                    const cleanJson = aiRes.replace(/```json|```/g, '').trim();
                    const data = JSON.parse(cleanJson);
                    let color = data.status === 'green' ? 'success' : (data.status === 'yellow' ? 'warning' : 'danger');
                    resDiv.innerHTML = `<div class="alert alert-${color}"><strong>ü§ñ AI: ${data.name}</strong><br>${data.reason}</div>`;
                } catch (e) { resDiv.innerHTML = `<div class="alert alert-secondary">${aiRes}</div>`; }
            }
        }

        function handleEnter(e) { if(e.key === 'Enter') searchWithAI(); }

        async function generateAIMenu() {
            const prompt = `G·ª£i √Ω th·ª±c ƒë∆°n h√¥m nay cho ng∆∞·ªùi b·ªã Gout, Men gan cao. Acid Uric ${healthProfile.lastCheckup.uric_acid}. M√≥n Vi·ªát Nam. Markdown.`;
            const aiRes = await callGemini(prompt);
            if(aiRes) {
                document.getElementById('menuResult').style.display = 'block';
                document.getElementById('menuContent').innerHTML = marked.parse(aiRes);
            }
        }
        
        async function checkHealthAI() {
             const prompt = `D·ª±a tr√™n ch·ªâ s·ªë: ${JSON.stringify(healthProfile.lastCheckup)}. Cho 3 l·ªùi khuy√™n ng·∫Øn g·ªçn.`;
             const aiRes = await callGemini(prompt);
             if(aiRes) {
                document.getElementById('menuResult').style.display = 'block';
                document.getElementById('menuContent').innerHTML = marked.parse(aiRes);
            }
        }

        document.getElementById('showKey').addEventListener('change', function() {
            document.getElementById('apiKeyInput').type = this.checked ? 'text' : 'password';
        });

        // Chart rendering code (Gi·ªØ nguy√™n nh∆∞ c≈©)
        function renderLabChart(logs) {
            const ctx = document.getElementById('labChart').getContext('2d');
            const pointColors = logs.map(l => (l.note||'').includes('c·∫•p') ? '#e74c3c' : ((l.note||'').includes('t·ªët') ? '#27ae60' : '#f1c40f'));
            const pointStyles = logs.map(l => (l.note||'').includes('t·ªët') ? 'star' : ((l.note||'').includes('c·∫•p') ? 'rectRot' : 'circle'));
            const pointSizes = logs.map(l => (l.note && l.note.length > 5) ? 8 : 4);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [
                        { label: 'Gout', data: logs.map(l => l.uric_acid), borderColor: '#e74c3c', pointBackgroundColor: pointColors, pointStyle: pointStyles, pointRadius: pointSizes, yAxisID: 'y' },
                        { label: 'Men gan', data: logs.map(l => l.alt_liver), borderColor: '#f1c40f', pointRadius: 0, yAxisID: 'y1' }
                    ]
                },
                options: { responsive: true, scales: { y: {position:'left'}, y1: {position:'right', grid:{drawOnChartArea:false}} } }
            });
        }
        function renderWeightChart(logs, target) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [{ label: 'Kg', data: logs.map(l => l.value), borderColor: '#3498db', tension: 0.3 }]
                }
            });
        }
        
        // Admin Tool Logic
        function genCheckupJSON() {
            const obj = {
                date: document.getElementById('inpDate').value,
                uric_acid: parseFloat(document.getElementById('inpUric').value),
                alt_liver: parseFloat(document.getElementById('inpAlt').value),
                creatinine: parseFloat(document.getElementById('inpCre').value) || null,
                egfr: parseFloat(document.getElementById('inpEgfr').value) || null,
                note: document.getElementById('inpNote').value
            };
            const out = document.getElementById('jsonOutput');
            out.value = JSON.stringify(obj, null, 2) + ",";
            out.select(); document.execCommand('copy'); alert('ƒê√£ Copy!');
        }
    </script>
</body>
</html>